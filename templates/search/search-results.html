{% extends 'base/base.html'%}
{% load static %}

{% block content%}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Information</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</head>

<body class="bg-gray-100">
  <section class="relative py-24 overflow-hidden">
    <img class="absolute top-0 left-0 w-full h-full"
      src="{% static 'template-assets/background/background-color-paint.png' %}" alt="" />
    <div class="container px-4 mx-auto">
      <div
        class="relative w-full md:max-w-xl lg:max-w-4xl mx-auto px-6 md:px-20 py-10 md:py-20 bg-white rounded-4xl h-auto">
        <h1 class="text-3xl font-semibold text-gray-800 text-center">Carfinity Report</h1>
        <br></br>
        <!-- Help Information Banner -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-blue-600 text-xl mt-1"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-lg font-medium text-blue-800 mb-2">Understanding Your Vehicle Report</h3>
              <p class="text-blue-700 text-sm mb-2">
                This comprehensive report provides detailed information about the vehicle's history, condition, and
                specifications.
                Use this data to make informed decisions about your vehicle purchase or ownership.
              </p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-blue-600">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt mr-2"></i>
                  <span>Status indicators show vehicle safety and legal standing</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-history mr-2"></i>
                  <span>Historical records provide maintenance and inspection details</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-cog mr-2"></i>
                  <span>Technical specifications help verify vehicle authenticity</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-camera mr-2"></i>
                  <span>Images provide visual confirmation of vehicle condition</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="flex flex-col sm:flex-row sm:items-center p-4 sm:p-6 border-b gap-4 sm:gap-6">
            {% if vehicle_images %}
            <img src="{{ vehicle_images.0.image.url }}"
              alt="{{ vehicle_images.0.get_image_type_display }} - {{ vehicle.vin }}"
              class="w-20 h-20 sm:w-24 sm:h-24 object-cover rounded-lg mx-auto sm:mx-0 flex-shrink-0">
            {% else %}
            <!-- No images available - show placeholder with clear indication -->
            <div
              class="w-20 h-20 sm:w-24 sm:h-24 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg mx-auto sm:mx-0 flex flex-col items-center justify-center flex-shrink-0">
              <i class="fas fa-image text-gray-400 text-base sm:text-lg mb-1"></i>
              <span class="text-xs text-gray-400">No Image</span>
            </div>
            {% endif %}
            <div class="text-center sm:text-left min-w-0 flex-1">
              <h1 class="text-xl sm:text-2xl font-semibold text-gray-800 break-words">{{ vehicle.make }} {{ vehicle.model }}</h1>
              <p class="text-sm sm:text-base text-gray-600 mt-1 break-all">VIN: {{ vehicle.vin }} ({{ vehicle.manufacture_year }})</p>
            </div>
          </div>

          <!-- Vehicle Status Section -->
          <div class="p-6 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
              <h2 class="text-xl font-semibold text-gray-800">Vehicle Status Overview</h2>
              <div class="text-xs sm:text-sm text-gray-500 flex items-center">
                <i class="fas fa-question-circle mr-1"></i>
                <span class="hidden sm:inline">Color coding: Green = Good, Yellow = Caution, Red = Alert</span>
                <span class="sm:hidden">Green = Good, Yellow = Caution, Red = Alert</span>
              </div>
            </div>

            <!-- Status Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">
              <!-- Accident History -->
              <div
                class="flex flex-col sm:flex-row items-center justify-center p-3 sm:p-4 {% if status.accident_history == 'NHA' %}bg-green-100 border-green-300{% elif status.accident_history == 'CAD' %}bg-red-100 border-red-300{% else %}bg-yellow-100 border-yellow-300{% endif %} rounded-lg border">
                <div
                  class="text-2xl sm:text-xl mb-2 sm:mb-0 {% if status.accident_history == 'NHA' %}text-green-600{% elif status.accident_history == 'CAD' %}text-red-600{% else %}text-yellow-600{% endif %}">
                  <i class="fas fa-car-crash"></i>
                </div>
                <div class="sm:ml-4 text-center">
                  <p class="font-semibold text-gray-700 text-sm sm:text-base">Accidents</p>
                  <p
                    class="{% if status.accident_history == 'NHA' %}text-green-600{% elif status.accident_history == 'CAD' %}text-red-600{% else %}text-yellow-600{% endif %} text-xs sm:text-sm">
                    {{ status.get_accident_history_display }}
                  </p>
                </div>
              </div>

              <!-- Theft Status -->
              <div
                class="flex flex-col sm:flex-row items-center justify-center p-3 sm:p-4 {% if status.theft_involvement == 'NHT' %}bg-green-100 border-green-300{% elif status.theft_involvement == 'STI' %}bg-red-100 border-red-300{% else %}bg-yellow-100 border-yellow-300{% endif %} rounded-lg border">
                <div
                  class="text-2xl sm:text-xl mb-2 sm:mb-0 {% if status.theft_involvement == 'NHT' %}text-green-600{% elif status.theft_involvement == 'STI' %}text-red-600{% else %}text-yellow-600{% endif %}">
                  <i class="fas fa-user-lock"></i>
                </div>
                <div class="sm:ml-4 text-center">
                  <p class="font-semibold text-gray-700 text-sm sm:text-base">Theft</p>
                  <p
                    class="{% if status.theft_involvement == 'NHT' %}text-green-600{% elif status.theft_involvement == 'STI' %}text-red-600{% else %}text-yellow-600{% endif %} text-xs sm:text-sm">
                    {{ status.get_theft_involvement_display }}
                  </p>
                </div>
              </div>

              <!-- Odometer Status -->
              <div
                class="flex flex-col sm:flex-row items-center justify-center p-3 sm:p-4 {% if status.odometer_fraud == 'NOF' %}bg-green-100 border-green-300{% else %}bg-red-100 border-red-300{% endif %} rounded-lg border">
                <div
                  class="text-2xl sm:text-xl mb-2 sm:mb-0 {% if status.odometer_fraud == 'NOF' %}text-green-600{% else %}text-red-600{% endif %}">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="sm:ml-4 text-center">
                  <p class="font-semibold text-gray-700 text-sm sm:text-base">Odometer</p>
                  <p
                    class="{% if status.odometer_fraud == 'NOF' %}text-green-600{% else %}text-red-600{% endif %} text-xs sm:text-sm">
                    {{ status.get_odometer_fraud_display }}
                  </p>
                </div>
              </div>

              <!-- Legal Status -->
              <div
                class="flex flex-col sm:flex-row items-center justify-center p-3 sm:p-4 {% if status.legal_status == 'LG' %}bg-green-100 border-green-300{% else %}bg-red-100 border-red-300{% endif %} rounded-lg border">
                <div
                  class="text-2xl sm:text-xl mb-2 sm:mb-0 {% if status.legal_status == 'LG' %}text-green-600{% else %}text-red-600{% endif %}">
                  <i class="fas fa-balance-scale"></i>
                </div>
                <div class="sm:ml-4 text-center">
                  <p class="font-semibold text-gray-700 text-sm sm:text-base">Legal Status</p>
                  <p
                    class="{% if status.legal_status == 'LG' %}text-green-600{% else %}text-red-600{% endif %} text-xs sm:text-sm">
                    {{ status.get_legal_status_display }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Previous Owners Section -->
            <div class="bg-gray-50 rounded-lg p-4 border">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex items-center">
                  <div class="text-2xl text-blue-600 mr-3 flex-shrink-0">
                    <i class="fas fa-users"></i>
                  </div>
                  <div class="min-w-0">
                    <p class="font-semibold text-gray-700 text-sm sm:text-base">Previous Owners</p>
                    <p class="text-xs sm:text-sm text-gray-500">Number of previous vehicle owners</p>
                  </div>
                </div>
                <div class="text-center sm:text-right flex-shrink-0">
                  <div
                    class="text-2xl sm:text-3xl font-bold {% if status.owner_history == 0 %}text-green-600{% elif status.owner_history <= 2 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {{ status.owner_history }}
                  </div>
                  <div
                    class="text-xs {% if status.owner_history == 0 %}text-green-600{% elif status.owner_history <= 2 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {% if status.owner_history == 0 %}
                    First Owner
                    {% elif status.owner_history == 1 %}
                    One Previous Owner
                    {% else %}
                    Multiple Owners
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Vehicle Images Section -->
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">Vehicle Images</h2>
              <div class="text-sm text-gray-500 flex items-center">
                <i class="fas fa-mouse-pointer mr-1"></i>
                <span>Click images to view in full size</span>
              </div>
            </div>
            {% if vehicle_images %}
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {% for image in vehicle_images %}
              <div class="relative group">
                <div class="aspect-w-4 aspect-h-3 bg-gray-100 rounded-lg overflow-hidden">
                  <img src="{{ image.image.url }}" alt="{{ image.get_image_type_display }} - {{ vehicle.vin }}"
                    class="w-full h-48 object-cover rounded-lg hover:scale-105 transition-transform duration-200 cursor-pointer"
                    onclick="openImageModal('{{ image.image.url }}', '{{ image.get_image_type_display }}', '{{ image.description|default:'' }}')">
                </div>
                <div class="mt-2 text-center">
                  <p class="text-sm font-medium text-gray-700">{{ image.get_image_type_display }}</p>
                  {% if image.is_primary %}
                  <span
                    class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mt-1">Primary</span>
                  {% endif %}
                  {% if image.description %}
                  <p class="text-xs text-gray-500 mt-1">{{ image.description }}</p>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <!-- No Images Found Message -->
            <div
              class="flex flex-col items-center justify-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
              <div class="text-6xl text-gray-400 mb-4">
                <i class="fas fa-image"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-700 mb-2">No Vehicle Images Available</h3>
              <p class="text-gray-500 text-center max-w-md">
                No images have been uploaded for this vehicle yet. Images may be added during future inspections or
                maintenance visits.
              </p>
              <div class="mt-4 flex items-center text-sm text-gray-400">
                <i class="fas fa-info-circle mr-2"></i>
                <span>Check back later for updated vehicle photos</span>
              </div>
            </div>
            {% endif %}
          </div>

          <div class="p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
              <h2 class="text-lg sm:text-xl font-semibold">Identification and Technical Specifications</h2>
              <div class="text-xs sm:text-sm text-gray-500 flex items-center">
                <i class="fas fa-id-card mr-1"></i>
                <span class="hidden sm:inline">Verify these details match your vehicle documentation</span>
                <span class="sm:hidden">Verify details match documentation</span>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Make</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.make }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Model</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.model }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Body type</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.body_type }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Manufacture year</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.manufacture_year }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Engine Code</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.engine_code }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Interior Color</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.interior_color }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Exterior Color</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.exterior_color }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Fuel Type</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.fuel_type }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Transmission Type</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.transmission_type }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Powertrain Displacement</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.powertrain_displacement }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Powertrain Power</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.powertrain_power }}</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 border">
                <p class="text-xs sm:text-sm text-gray-500 mb-1">Plant Location</p>
                <p class="font-semibold text-sm sm:text-base break-words">{{ vehicle.plant_location }}</p>
              </div>
            </div>
          </div>

          <div class="h-px w-100 bg-gray-100"></div>

          <!-- Equipment Section -->
          {% include "search/equipment.html" %}

          <!-- Inspections -->
          <div class="bg-white p-5 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-semibold text-gray-800">Inspections</h2>
              <button id="toggleInspectionsBtn" onclick="toggleInspections()"
                class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                <span id="toggleInspectionsText">Show Inspections</span>
                <i id="toggleInspectionsIcon" class="fas fa-chevron-down ml-2 transition-transform duration-200"></i>
              </button>
            </div>

            <!-- Help text for inspections -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
              <div class="flex items-start">
                <i class="fas fa-lightbulb text-green-600 mt-1 mr-2"></i>
                <div class="text-sm text-green-700">
                  <strong>About Inspections:</strong> These are official vehicle safety and emissions inspections
                  conducted by certified facilities.
                  Higher ratings indicate better vehicle condition. Regular inspections help ensure vehicle safety and
                  compliance.
                </div>
              </div>
            </div>

            <!-- Initial Inspections Information Block -->
            {% if initial_inspections %}
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 sm:p-4 mb-4">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-3">
                <div class="flex items-center">
                  <i class="fas fa-search-plus text-amber-600 text-lg sm:text-xl mr-2 sm:mr-3 flex-shrink-0"></i>
                  <div class="min-w-0">
                    <h3 class="text-base sm:text-lg font-semibold text-amber-800">Initial Vehicle Inspections</h3>
                    <p class="text-xs sm:text-sm text-amber-700">Comprehensive 160-point pre-purchase inspections</p>
                  </div>
                </div>
                <div class="text-center sm:text-right flex-shrink-0">
                  <div class="text-xl sm:text-2xl font-bold text-amber-600">{{ initial_inspections|length }}</div>
                  <div class="text-xs text-amber-600">
                    {% if initial_inspections|length == 1 %}
                    Initial Inspection
                    {% else %}
                    Initial Inspections
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="space-y-4 mb-4">
                {% for initial_inspection in initial_inspections %}
                <div class="bg-white border border-amber-200 rounded-lg p-3 sm:p-4">
                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2">
                    <div class="flex items-center min-w-0">
                      <div
                        class="bg-amber-100 text-amber-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-semibold mr-2 flex-shrink-0">
                        {{ forloop.counter }}
                      </div>
                      <div class="min-w-0">
                        <h4 class="font-semibold text-gray-800 text-sm break-words">{{ initial_inspection.inspection_number }}</h4>
                        <p class="text-xs text-gray-500">
                          <i class="fas fa-calendar mr-1"></i>
                          {{ initial_inspection.inspection_date|date:"M j, Y" }}
                        </p>
                      </div>
                    </div>
                    <div class="flex-shrink-0">
                      {% if initial_inspection.is_completed %}
                      <span
                        class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check mr-1"></i>Completed
                      </span>
                      {% else %}
                      <span
                        class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        <i class="fas fa-clock mr-1"></i>In Progress
                      </span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="space-y-3 mb-3">
                    <div>
                      <span class="text-gray-500 text-xs">Progress:</span>
                      <div class="flex items-center mt-1">
                        <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3">
                          <div class="bg-amber-600 h-2 rounded-full"
                            style="width: {{ initial_inspection.completion_percentage }}%"></div>
                        </div>
                        <span class="text-gray-600 font-medium text-sm flex-shrink-0">{{ initial_inspection.completion_percentage }}%</span>
                      </div>
                    </div>
                    <div>
                      <span class="text-gray-500 text-xs">Technician:</span>
                      <p class="font-medium text-gray-700 mt-1 text-sm break-words">
                        {% if initial_inspection.technician %}
                        {{ initial_inspection.technician.get_full_name|default:initial_inspection.technician.username }}
                        {% else %}
                        Not Assigned
                        {% endif %}
                      </p>
                    </div>
                  </div>

                  <!-- Vehicle Health Index and Results -->
                  <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <div class="space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-3 text-xs">
                      <div>
                        <span class="text-gray-500">Health Index:</span>
                        <div class="mt-1">
                          {% with health_index=initial_inspection.vehicle_health_index %}
                          {% if health_index == "Not Calculated" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              <i class="fas fa-clock text-gray-600 mr-1"></i>Not Calculated
                            </span>
                          {% elif "Excellent" in health_index %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                              <i class="fas fa-heart text-green-600 mr-1"></i>{{ health_index }}
                            </span>
                          {% elif "Good" in health_index %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              <i class="fas fa-heart text-blue-600 mr-1"></i>{{ health_index }}
                            </span>
                          {% elif "Fair" in health_index %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                              <i class="fas fa-heart text-yellow-600 mr-1"></i>{{ health_index }}
                            </span>
                          {% elif "Poor" in health_index %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                              <i class="fas fa-heart text-orange-600 mr-1"></i>{{ health_index }}
                            </span>
                          {% elif "Critical" in health_index %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              <i class="fas fa-heart text-red-600 mr-1"></i>{{ health_index }}
                            </span>
                          {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              <i class="fas fa-question text-gray-600 mr-1"></i>{{ health_index|default:"Unknown" }}
                            </span>
                          {% endif %}
                          {% endwith %}
                        </div>
                      </div>
                      <div>
                        <span class="text-gray-500">Result:</span>
                        <div class="mt-1">
                          {% with result=initial_inspection.inspection_result %}
                          {% if result == "Pending" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              <i class="fas fa-clock mr-1"></i>Pending
                            </span>
                          {% elif result == "PAS" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                              <i class="fas fa-check-circle mr-1"></i>Passed
                            </span>
                          {% elif result == "PMD" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              <i class="fas fa-info-circle mr-1"></i>Pass (Minor)
                            </span>
                          {% elif result == "PJD" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                              <i class="fas fa-exclamation-circle mr-1"></i>Pass (Major)
                            </span>
                          {% elif result == "FMD" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                              <i class="fas fa-times-circle mr-1"></i>Failed (Minor)
                            </span>
                          {% elif result == "FJD" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              <i class="fas fa-times-circle mr-1"></i>Failed (Major)
                            </span>
                          {% elif result == "FAI" %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              <i class="fas fa-ban mr-1"></i>Failed
                            </span>
                          {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              <i class="fas fa-question mr-1"></i>{{ result|default:"Unknown" }}
                            </span>
                          {% endif %}
                          {% endwith %}
                        </div>
                      </div>
                    </div>
                    
                    <div class="space-y-3 sm:space-y-0 sm:grid sm:grid-cols-2 sm:gap-3 text-xs mt-3">
                      <div>
                        <span class="text-gray-500">Failed Points:</span>
                        <div class="mt-1">
                          {% with failed_count=initial_inspection.failed_points|length %}
                          {% if failed_count is not None %}
                            {% if failed_count > 0 %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              <i class="fas fa-exclamation-triangle mr-1"></i>{{ failed_count }} Issue{{ failed_count|pluralize }}
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                              <i class="fas fa-check mr-1"></i>No Issues
                            </span>
                            {% endif %}
                          {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              <i class="fas fa-clock mr-1"></i>Not Available
                            </span>
                          {% endif %}
                          {% endwith %}
                        </div>
                      </div>
                      <div>
                        <span class="text-gray-500">Critical Issues:</span>
                        <div class="mt-1">
                          {% with critical_count=initial_inspection.safety_critical_issues|length %}
                          {% if critical_count is not None %}
                            {% if critical_count > 0 %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              <i class="fas fa-shield-alt mr-1"></i>{{ critical_count }} Critical
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                              <i class="fas fa-shield-alt mr-1"></i>None
                            </span>
                            {% endif %}
                          {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              <i class="fas fa-clock mr-1"></i>Not Available
                            </span>
                          {% endif %}
                          {% endwith %}
                        </div>
                      </div>
                    </div>
                  </div>

                  {% if initial_inspection.has_major_issues %}
                  <div class="bg-red-50 border border-red-200 rounded p-2 mb-3">
                    <div class="flex items-center text-xs text-red-700">
                      <i class="fas fa-exclamation-triangle mr-1"></i>
                      <span class="font-medium">{{ initial_inspection.failed_points|length }} Issue(s) Found</span>
                    </div>
                  </div>
                  {% endif %}

                  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <div class="text-xs text-gray-500">
                      <i class="fas fa-tachometer-alt mr-1"></i>
                      {{ initial_inspection.mileage_at_inspection|floatformat:0 }} miles
                    </div>
                    <button
                      onclick="openInitialInspectionModal('{{ initial_inspection.id }}', '{{ initial_inspection.inspection_number }}')"
                      class="px-3 py-2 bg-amber-600 text-white rounded text-xs hover:bg-amber-700 transition-colors duration-200 w-full sm:w-auto">
                      <i class="fas fa-eye mr-1"></i>View Details
                    </button>
                  </div>
                </div>
                {% endfor %}
              </div>

              <div class="bg-amber-100 border border-amber-300 rounded-lg p-3">
                <div class="flex items-start">
                  <i class="fas fa-info-circle text-amber-600 mt-0.5 mr-2 flex-shrink-0"></i>
                  <div class="text-xs sm:text-sm text-amber-800 min-w-0">
                    <strong>About Initial Inspections:</strong> These comprehensive 160-point inspections are conducted
                    before a vehicle is onboarded to Carfinity AutoCare to establish a baseline Vehicle Health Index and generally assess its overall condition, identify potential issues, and provide purchase
                    recommendations. They include road testing, structural analysis, and detailed component evaluation.
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Summary when collapsed -->
            <div id="inspectionsSummary" class="mb-4">
              <div class="bg-gray-50 rounded-lg p-4 border">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <div class="text-2xl text-green-600 mr-3">
                      <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-700">Total Inspections</p>
                      <p class="text-sm text-gray-500">Click "Show Inspections" to view detailed records</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold text-green-600">
                      {{ inspections|length }}
                    </div>
                    <div class="text-xs text-green-600">
                      {% if inspections|length == 0 %}
                      No Inspections
                      {% elif inspections|length == 1 %}
                      Inspection Found
                      {% else %}
                      Inspections Found
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detailed inspections (initially hidden) -->
            <div id="inspectionsDetails" class="overflow-x-auto hidden">
              {% if inspections %}
              {% for inspection in inspections %}
              <div class="bg-white border border-gray-200 rounded-lg mb-4 p-4 shadow-sm">
                <!-- Inspection Header -->
                <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-100">
                  <div class="flex items-center">
                    <div
                      class="bg-green-100 text-green-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-semibold mr-3">
                      {{ forloop.counter }}
                    </div>
                    <div>
                      <h4 class="font-semibold text-gray-800">{{ inspection.inspection_number }}</h4>
                      <p class="text-sm text-gray-500">
                        <i class="fas fa-calendar mr-1"></i>
                        {{ inspection.inspection_date|date:"F j, Y" }}
                      </p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-semibold 
                        {% if inspection.inspection_result == 'PAS' %}text-green-600
                        {% elif inspection.inspection_result == 'PMD' or inspection.inspection_result == 'PJD' %}text-yellow-600
                        {% else %}text-red-600{% endif %}">
                      {{ inspection.get_inspection_result_display }}
                    </div>
                    <div class="text-xs text-gray-500">{{ inspection.year }}</div>
                  </div>
                </div>

                <!-- Inspection Details Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  <!-- Inspection Result -->
                  <div class="flex items-center">
                    <div class="{% if inspection.inspection_result == 'PAS' %}text-green-600
                        {% elif inspection.inspection_result == 'PMD' or inspection.inspection_result == 'PJD' %}text-yellow-600
                        {% else %}text-red-600{% endif %} mr-2">
                      <i
                        class="fas fa-{% if inspection.inspection_result == 'PAS' %}check-circle{% elif inspection.inspection_result == 'PMD' or inspection.inspection_result == 'PJD' %}exclamation-triangle{% else %}times-circle{% endif %}"></i>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500">Inspection Result</p>
                      <p class="font-medium text-gray-700">{{ inspection.get_inspection_result_display }}</p>
                    </div>
                  </div>

                  <!-- Vehicle Health Index -->
                  <div class="flex items-center">
                    <div class="text-blue-600 mr-2">
                      <i class="fas fa-heartbeat"></i>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500">Vehicle Health Index</p>
                      <p class="font-medium text-gray-700">
                        {% if inspection.vehicle_health_index %}
                        {{ inspection.vehicle_health_index }}
                        {% else %}
                        Not Available
                        {% endif %}
                      </p>
                    </div>
                  </div>

                  <!-- PDF Report -->
                  <div class="flex items-center">
                    <div class="text-red-600 mr-2">
                      <i class="fas fa-file-pdf"></i>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500">Inspection Report</p>
                      <p class="font-medium text-gray-700">
                        {% if inspection.has_pdf %}
                        <button onclick="openInspectionPDF('{{ inspection.id }}', '{{ inspection.inspection_number }}')"
                          class="text-blue-600 hover:text-blue-800 underline text-sm">
                          <i class="fas fa-eye mr-1"></i>View PDF
                        </button>
                        <br><span class="text-xs text-gray-500">{{ inspection.pdf_file_size_mb }} MB</span>
                        {% else %}
                        <span class="text-gray-400">No PDF available</span>
                        {% endif %}
                      </p>
                    </div>
                  </div>
                </div>

                <!-- External Link Section -->
                {% if inspection.link_to_results %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                  <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-external-link-alt text-blue-600 mr-2"></i>
                    External Inspection Results
                  </h5>
                  <a href="{{ inspection.link_to_results }}" target="_blank"
                    class="text-blue-600 hover:text-blue-800 underline text-sm">
                    <i class="fas fa-link mr-1"></i>View External Results
                    <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                  </a>
                </div>
                {% endif %}

                <!-- Detailed Inspection Form Link -->
                {% if inspection.inspections_form %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <h5 class="font-semibold text-gray-700 mb-1 flex items-center">
                        <i class="fas fa-clipboard-list text-green-600 mr-2"></i>
                        50-Point Inspection Form
                      </h5>
                      <p class="text-sm text-gray-600">
                        Completion: {{ inspection.inspections_form.completion_percentage }}%
                        {% if inspection.inspections_form.is_completed %}
                        <span class="text-green-600 ml-2">
                          <i class="fas fa-check-circle"></i> Completed
                        </span>
                        {% else %}
                        <span class="text-yellow-600 ml-2">
                          <i class="fas fa-clock"></i> In Progress
                        </span>
                        {% endif %}
                      </p>
                      {% if inspection.inspections_form.technician %}
                      <p class="text-xs text-gray-500 mt-1">
                        Technician:
                        {% if inspection.inspections_form.technician.first_name or inspection.inspections_form.technician.last_name %}
                        {{ inspection.inspections_form.technician.first_name|default:"" }}{% if inspection.inspections_form.technician.first_name and inspection.inspections_form.technician.last_name %} {% endif %}{{ inspection.inspections_form.technician.last_name|default:"" }}
                        {% else %}
                        {{ inspection.inspections_form.technician.username }}
                        {% endif %}
                      </p>
                      {% endif %}
                    </div>
                    <button
                      onclick="openInspectionFormModal('{{ inspection.id }}', '{{ inspection.inspection_number }}')"
                      class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm">
                      <i class="fas fa-eye mr-1"></i>View Details
                    </button>
                  </div>
                </div>
                {% else %}
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                  <p class="text-sm text-gray-600 flex items-center">
                    <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                    No detailed inspection form available for this record
                  </p>
                </div>
                {% endif %}

                <!-- Inspection Metadata -->
                <div class="mt-3 pt-3 border-t border-gray-100">
                  <div class="flex items-center justify-between text-xs text-gray-500">
                    <div class="flex items-center">
                      <i class="fas fa-clock mr-1"></i>
                      <span>
                        {% if inspection.created_at %}
                        Created: {{ inspection.created_at|date:"M j, Y" }}
                        {% endif %}
                        {% if inspection.updated_at and inspection.updated_at != inspection.created_at %}
                        | Updated: {{ inspection.updated_at|date:"M j, Y" }}
                        {% endif %}
                      </span>
                    </div>
                    {% if inspection.pdf_uploaded_at %}
                    <div class="flex items-center">
                      <i class="fas fa-upload mr-1"></i>
                      <span>PDF uploaded: {{ inspection.pdf_uploaded_at|date:"M j, Y" }}</span>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
              {% else %}
              <div
                class="flex flex-col items-center justify-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <div class="text-6xl text-gray-400 mb-4">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-700 mb-2">No Inspection Records Available</h3>
                <p class="text-gray-500 text-center max-w-md">
                  No inspection records have been found for this vehicle. Inspections may be added when the vehicle
                  undergoes official safety and emissions testing.
                </p>
                <div class="mt-4 flex items-center text-sm text-gray-400">
                  <i class="fas fa-info-circle mr-2"></i>
                  <span>Check back after the next scheduled inspection</span>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          <!--End of Inspections-->

          <div class="h-px w-100 bg-gray-100"></div>

          <!-- Maintenance History -->
          <div class="bg-white p-5 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-semibold text-gray-800">Maintenance History</h2>
              <button id="toggleMaintenanceBtn" onclick="toggleMaintenanceHistory()"
                class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                <span id="toggleMaintenanceText">Show History</span>
                <i id="toggleMaintenanceIcon" class="fas fa-chevron-down ml-2 transition-transform duration-200"></i>
              </button>
            </div>

            <!-- Help text for maintenance -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
              <div class="flex items-start">
                <i class="fas fa-lightbulb text-blue-600 mt-1 mr-2"></i>
                <div class="text-sm text-blue-700">
                  <strong>About Maintenance History:</strong> These records show all documented maintenance work
                  performed on the vehicle.
                  Regular maintenance indicates good vehicle care and can help predict future reliability. Look for
                  consistent service intervals and major repairs.
                </div>
              </div>
            </div>

            <!-- Summary when collapsed -->
            <div id="maintenanceSummary" class="mb-4">
              <div class="bg-gray-50 rounded-lg p-4 border">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <div class="text-2xl text-blue-600 mr-3">
                      <i class="fas fa-wrench"></i>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-700">Total Maintenance Records</p>
                      <p class="text-sm text-gray-500">Click "Show History" to view detailed records</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold text-blue-600">
                      {{ maintenance_records|length }}
                    </div>
                    <div class="text-xs text-blue-600">
                      {% if maintenance_records|length == 0 %}
                      No Records
                      {% elif maintenance_records|length == 1 %}
                      Record Found
                      {% else %}
                      Records Found
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detailed maintenance history table (initially hidden) -->
            <div id="maintenanceDetails" class="overflow-x-auto hidden">
              {% if maintenance_records %}
              {% for record in maintenance_records %}
              <div class="bg-white border border-gray-200 rounded-lg mb-4 p-4 shadow-sm">
                <!-- Record Header -->
                <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-100">
                  <div class="flex items-center">
                    <div
                      class="bg-blue-100 text-blue-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-semibold mr-3">
                      {{ forloop.counter }}
                    </div>
                    <div>
                      <h4 class="font-semibold text-gray-800">{{ record.work_done }}</h4>
                      <p class="text-sm text-gray-500">
                        <i class="fas fa-calendar mr-1"></i>
                        {{ record.date_performed|date:"F j, Y \a\t g:i A" }}
                      </p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-semibold text-gray-700">{{ record.mileage|floatformat:0 }} mi</div>
                    <div class="text-xs text-gray-500">Mileage</div>
                  </div>
                </div>

                <!-- Record Details Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  <!-- Technician -->
                  <div class="flex items-center">
                    <div class="text-blue-600 mr-2">
                      <i class="fas fa-user-cog"></i>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500">Technician</p>
                      <p class="font-medium text-gray-700">
                        {% if record.technician %}
                        {% if record.technician.first_name or record.technician.last_name %}
                        {{ record.technician.first_name|default:"" }}{% if record.technician.first_name and record.technician.last_name %} {% endif %}{{ record.technician.last_name|default:"" }}
                        {% else %}
                        {{ record.technician.username }}
                        {% endif %}
                        {% if record.technician.email %}
                        <br><span class="text-xs text-gray-500">{{ record.technician.email }}</span>
                        {% endif %}
                        {% else %}
                        N/A
                        {% endif %}
                      </p>
                    </div>
                  </div>

                  <!-- Scheduled Maintenance -->
                  <div class="flex items-center">
                    <div class="text-green-600 mr-2">
                      <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500">Scheduled Maintenance</p>
                      <p class="font-medium text-gray-700">
                        {% if record.scheduled_maintenance %}
                        {{ record.scheduled_maintenance.maintenance_type }}
                        {% else %}
                        Unscheduled
                        {% endif %}
                      </p>
                    </div>
                  </div>

                  <!-- Service Image -->
                  <div class="flex items-center">
                    <div class="text-purple-600 mr-2">
                      <i class="fas fa-camera"></i>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500">Service Image</p>
                      <p class="font-medium text-gray-700">
                        {% if record.service_image %}
                        <button
                          onclick="openMaintenanceImageModal('{{ record.service_image.url }}', '{{ record.image_type_display }}', '{{ record.image_description|default:'' }}', '{{ record.work_done }}')"
                          class="text-blue-600 hover:text-blue-800 underline text-sm">
                          <i class="fas fa-eye mr-1"></i>View Image
                        </button>
                        {% if record.image_type %}
                        <br><span class="text-xs text-gray-500">{{ record.image_type_display }}</span>
                        {% endif %}
                        {% else %}
                        <span class="text-gray-400">No image</span>
                        {% endif %}
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Parts Used Section -->
                {% if record.parts_used.all %}
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                  <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-cogs text-orange-600 mr-2"></i>
                    Parts Used
                  </h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    {% for part_usage in record.parts_used.all %}
                    <div class="flex items-center justify-between bg-white rounded p-2 border">
                      <div>
                        <p class="font-medium text-gray-700">{{ part_usage.part.name }}</p>
                        <p class="text-xs text-gray-500">Qty: {{ part_usage.quantity }}</p>
                      </div>
                      {% if part_usage.unit_cost %}
                      <div class="text-right">
                        <p class="font-semibold text-gray-700">R{{ part_usage.total_cost|floatformat:2 }}</p>
                        <p class="text-xs text-gray-500">R{{ part_usage.unit_cost|floatformat:2 }} each</p>
                      </div>
                      {% endif %}
                    </div>
                    {% endfor %}
                  </div>
                  <div class="mt-2 pt-2 border-t border-gray-200">
                    <div class="text-center">
                      <span class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Individual part costs shown above
                      </span>
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Notes Section -->
                {% if record.notes %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                  <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>
                    Additional Notes
                  </h5>
                  <p class="text-gray-700 text-sm">{{ record.notes }}</p>
                </div>
                {% endif %}

                <!-- Image Description -->
                {% if record.image_description %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                    <i class="fas fa-image text-blue-600 mr-2"></i>
                    Image Description
                  </h5>
                  <p class="text-gray-700 text-sm">{{ record.image_description }}</p>
                </div>
                {% endif %}

                <!-- Record Timestamps -->
                <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between text-xs text-gray-400">
                  <span>
                    <i class="fas fa-plus-circle mr-1"></i>
                    Created: {{ record.created_at|date:"M j, Y g:i A" }}
                  </span>
                  {% if record.updated_at != record.created_at %}
                  <span>
                    <i class="fas fa-edit mr-1"></i>
                    Updated: {{ record.updated_at|date:"M j, Y g:i A" }}
                  </span>
                  {% endif %}
                </div>
              </div>
              {% empty %}
              <div class="p-8 text-center text-gray-500">
                <div class="flex flex-col items-center">
                  <i class="fas fa-clipboard-list text-4xl mb-3 text-gray-300"></i>
                  <h3 class="text-lg font-medium text-gray-600 mb-2">No Maintenance Records Found</h3>
                  <p class="text-gray-500 max-w-md">
                    No maintenance records have been documented for this vehicle yet.
                    Regular maintenance records help track vehicle care and can indicate reliability.
                  </p>
                </div>
              </div>
              {% endfor %}
              {% endif %}
            </div>
          </div>

        </div>

        <!-- Comprehensive Help Section -->
        <div class="mt-8 bg-gray-50 rounded-lg p-6 border">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-question-circle text-blue-600 mr-2"></i>
            How to Interpret This Report
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Status Indicators -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-traffic-light text-green-600 mr-2"></i>
                Status Color Guide
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                  <span><strong>Green:</strong> Good condition, no issues detected</span>
                </div>
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
                  <span><strong>Yellow:</strong> Caution, minor issues or unknown status</span>
                </div>
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                  <span><strong>Red:</strong> Alert, significant issues detected</span>
                </div>
              </div>
            </div>

            <!-- Key Metrics -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                Key Factors to Consider
              </h4>
              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Accident History:</strong> Check for any collision damage that may affect safety</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Owner Count:</strong> Fewer owners typically indicate better care</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Maintenance:</strong> Regular service indicates responsible ownership</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Inspections:</strong> Recent passes show current roadworthiness</span>
                </div>
              </div>
            </div>

            <!-- What to Do Next -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-clipboard-list text-purple-600 mr-2"></i>
                Recommended Actions
              </h4>
              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Verify VIN matches vehicle documentation</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Review maintenance history for regular service</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Check for any red status indicators</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Consider professional inspection if purchasing</span>
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-phone text-orange-600 mr-2"></i>
                Need Help?
              </h4>
              <div class="space-y-2 text-sm text-gray-600">
                <p>If you have questions about this report or need clarification on any information:</p>
                <div class="flex items-center">
                  <i class="fas fa-envelope text-blue-500 mr-2"></i>
                  <span>Contact our support team for assistance</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-clock text-green-500 mr-2"></i>
                  <span>Reports are updated as new information becomes available</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Disclaimer -->
          <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start">
              <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-1"></i>
              <div class="text-sm text-yellow-800">
                <strong>Important:</strong> This report is based on available data and should be used as a reference
                tool.
                Always conduct a thorough physical inspection and consider professional evaluation before making
                purchase decisions.
                Information accuracy depends on data sources and reporting completeness.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Image Modal for larger view -->
  <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
    <div class="relative max-w-4xl max-h-full mx-4">
      <button onclick="closeImageModal()"
        class="absolute top-4 right-4 text-white text-2xl font-bold hover:text-gray-300 z-10">
        &times;
      </button>
      <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
      <div id="modalCaption" class="text-white text-center mt-4"></div>
    </div>
  </div>

  <script>
    function openImageModal(imageUrl, imageType, description) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalCaption = document.getElementById('modalCaption');

      modalImage.src = imageUrl;
      modalImage.alt = imageType;

      let caption = imageType;
      if (description) {
        caption += ' - ' + description;
      }
      modalCaption.textContent = caption;

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Handle image loading errors
    function handleImageError(img) {
      const placeholder = document.createElement('div');
      placeholder.className = 'w-full h-48 bg-gray-200 rounded-lg flex flex-col items-center justify-center text-gray-500';
      placeholder.innerHTML = '<i class="fas fa-exclamation-triangle text-2xl mb-2"></i><span class="text-sm">Image not available</span>';

      img.parentNode.replaceChild(placeholder, img);
    }

    // Add error handling to all vehicle images
    document.addEventListener('DOMContentLoaded', function () {
      const vehicleImages = document.querySelectorAll('img[alt*="VIN"]');
      vehicleImages.forEach(function (img) {
        img.onerror = function () {
          handleImageError(this);
        };
      });
    });

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Maintenance image modal function
    function openMaintenanceImageModal(imageUrl, imageType, description, workDone) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalCaption = document.getElementById('modalCaption');

      modalImage.src = imageUrl;
      modalImage.alt = `${imageType} - ${workDone}`;

      let caption = `${imageType} - ${workDone}`;
      if (description) {
        caption += '\n' + description;
      }
      modalCaption.textContent = caption;

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Close modal when clicking outside the image
    document.getElementById('imageModal').addEventListener('click', function (e) {
      if (e.target === this) {
        closeImageModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        closeImageModal();
      }
    });

    // Toggle maintenance history visibility
    function toggleMaintenanceHistory() {
      const details = document.getElementById('maintenanceDetails');
      const summary = document.getElementById('maintenanceSummary');
      const toggleText = document.getElementById('toggleMaintenanceText');
      const toggleIcon = document.getElementById('toggleMaintenanceIcon');

      if (details.classList.contains('hidden')) {
        // Show details, hide summary
        details.classList.remove('hidden');
        summary.classList.add('hidden');
        toggleText.textContent = 'Hide History';
        toggleIcon.classList.add('rotate-180');
      } else {
        // Hide details, show summary
        details.classList.add('hidden');
        summary.classList.remove('hidden');
        toggleText.textContent = 'Show History';
        toggleIcon.classList.remove('rotate-180');
      }
    }

    // Toggle inspections visibility
    function toggleInspections() {
      const details = document.getElementById('inspectionsDetails');
      const summary = document.getElementById('inspectionsSummary');
      const toggleText = document.getElementById('toggleInspectionsText');
      const toggleIcon = document.getElementById('toggleInspectionsIcon');

      if (details.classList.contains('hidden')) {
        // Show details, hide summary
        details.classList.remove('hidden');
        summary.classList.add('hidden');
        toggleText.textContent = 'Hide Inspections';
        toggleIcon.classList.add('rotate-180');
      } else {
        // Hide details, show summary
        details.classList.add('hidden');
        summary.classList.remove('hidden');
        toggleText.textContent = 'Show Inspections';
        toggleIcon.classList.remove('rotate-180');
      }
    }

    // Open inspection PDF in new window/tab
    function openInspectionPDF(inspectionId, inspectionNumber) {
      const url = `/maintenance-history/inspection/${inspectionId}/pdf/`;
      window.open(url, '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');
    }

    // Open inspection form details modal
    function openInspectionFormModal(inspectionId, inspectionNumber) {
      // Create modal HTML
      const modalHTML = `
        <div id="inspectionFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
              <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-clipboard-list text-green-600 mr-2"></i>
                Inspection Form Details - ${inspectionNumber}
              </h3>
              <button onclick="closeInspectionFormModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
              <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                <span class="ml-3 text-gray-600">Loading inspection details...</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.body.style.overflow = 'hidden';

      // Load inspection form details via AJAX
      console.log('Loading inspection form details for ID:', inspectionId);
      fetch(`/inspection-form/ajax/${inspectionId}/`)
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            updateInspectionFormModalContent(data.html);
          } else {
            updateInspectionFormModalContent(`
              <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                <p class="text-gray-600">Error loading inspection form details.</p>
                <p class="text-sm text-gray-500 mt-2">${data.error || 'Please try again later.'}</p>
              </div>
            `);
          }
        })
        .catch(error => {
          console.error('Network error:', error);
          updateInspectionFormModalContent(`
            <div class="text-center py-8">
              <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
              <p class="text-gray-600">Network error occurred.</p>
              <p class="text-sm text-gray-500 mt-2">Please check your connection and try again.</p>
              <p class="text-xs text-gray-400 mt-2">Error: ${error.message}</p>
            </div>
          `);
        });
    }

    // Update inspection form modal content
    function updateInspectionFormModalContent(html) {
      const modal = document.getElementById('inspectionFormModal');
      if (modal) {
        const contentDiv = modal.querySelector('.overflow-y-auto');
        if (contentDiv) {
          contentDiv.innerHTML = html;
        }
      }
    }

    // Close inspection form modal
    function closeInspectionFormModal() {
      const modal = document.getElementById('inspectionFormModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function (e) {
      if (e.target && e.target.id === 'inspectionFormModal') {
        closeInspectionFormModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('inspectionFormModal');
        if (modal) {
          closeInspectionFormModal();
        }
      }
    });

    // Open initial inspection details modal
    function openInitialInspectionModal(inspectionId, inspectionNumber) {
      // Create modal HTML
      const modalHTML = `
        <div id="initialInspectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
              <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-search-plus text-amber-600 mr-2"></i>
                Initial Inspection Details - ${inspectionNumber}
              </h3>
              <button onclick="closeInitialInspectionModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
              <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600"></div>
                <span class="ml-3 text-gray-600">Loading initial inspection details...</span>
              </div>
            </div>
          </div>
        </div>
      `;

      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.body.style.overflow = 'hidden';

      // Load initial inspection details via AJAX
      console.log('Loading initial inspection details for ID:', inspectionId);
      fetch(`/initial-inspection/ajax/${inspectionId}/`)
        .then(response => {
          console.log('Response status:', response.status);
          
          // Check if response is ok and content-type is JSON
          const contentType = response.headers.get('content-type');
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned HTML instead of JSON. The endpoint may not exist.');
          }
          
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            updateInitialInspectionModalContent(data.html);
          } else {
            updateInitialInspectionModalContent(`
              <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                <p class="text-gray-600">Error loading initial inspection details.</p>
                <p class="text-sm text-gray-500 mt-2">${data.error || 'Please try again later.'}</p>
              </div>
            `);
          }
        })
        .catch(error => {
          console.error('Network error:', error);
          
          // Show appropriate error message based on error type
          let errorMessage = 'Network error occurred.';
          let errorDetail = 'Please check your connection and try again.';
          
          if (error.message.includes('HTML instead of JSON')) {
            errorMessage = 'Feature not yet implemented.';
            errorDetail = 'The initial inspection details endpoint is not available yet.';
          } else if (error.message.includes('HTTP 404')) {
            errorMessage = 'Endpoint not found.';
            errorDetail = 'The initial inspection details service is not configured.';
          } else if (error.message.includes('HTTP 500')) {
            errorMessage = 'Server error occurred.';
            errorDetail = 'Please try again later or contact support.';
          }
          
          updateInitialInspectionModalContent(`
            <div class="text-center py-8">
              <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
              <p class="text-gray-600">${errorMessage}</p>
              <p class="text-sm text-gray-500 mt-2">${errorDetail}</p>
              <p class="text-xs text-gray-400 mt-2">Error: ${error.message}</p>
            </div>
          `);
        });
    }

    // Update initial inspection modal content
    function updateInitialInspectionModalContent(html) {
      const modal = document.getElementById('initialInspectionModal');
      if (modal) {
        const contentDiv = modal.querySelector('.overflow-y-auto');
        if (contentDiv) {
          contentDiv.innerHTML = html;
        }
      }
    }

    // Close initial inspection modal
    function closeInitialInspectionModal() {
      const modal = document.getElementById('initialInspectionModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function (e) {
      if (e.target && e.target.id === 'initialInspectionModal') {
        closeInitialInspectionModal();
      }
    });

    // Close modal with Escape key for initial inspection
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('initialInspectionModal');
        if (modal) {
          closeInitialInspectionModal();
        }
      }
    });
  </script>
</body>

</html>
{% endblock %}