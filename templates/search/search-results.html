{% extends 'base/base.html'%}
{% load static %}

{% block content%}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Information</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</head>

<body class="bg-gray-100">
  <section class="relative py-24 overflow-hidden">
    <img class="absolute top-0 left-0 w-full h-full"
      src="{% static 'template-assets/background/background-color-paint.png' %}" alt="" />
    <div class="container px-4 mx-auto">
      <div
        class="relative w-full md:max-w-xl lg:max-w-4xl mx-auto px-6 md:px-20 py-10 md:py-20 bg-white rounded-4xl h-auto">
        <h1 class="text-3xl font-semibold text-gray-800 text-center">Carfinity Report</h1>
        
        <!-- Help Information Banner -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-blue-600 text-xl mt-1"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-lg font-medium text-blue-800 mb-2">Understanding Your Vehicle Report</h3>
              <p class="text-blue-700 text-sm mb-2">
                This comprehensive report provides detailed information about the vehicle's history, condition, and specifications. 
                Use this data to make informed decisions about your vehicle purchase or ownership.
              </p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-blue-600">
                <div class="flex items-center">
                  <i class="fas fa-shield-alt mr-2"></i>
                  <span>Status indicators show vehicle safety and legal standing</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-history mr-2"></i>
                  <span>Historical records provide maintenance and inspection details</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-cog mr-2"></i>
                  <span>Technical specifications help verify vehicle authenticity</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-camera mr-2"></i>
                  <span>Images provide visual confirmation of vehicle condition</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="flex items-center p-6 border-b">
            {% if vehicle_images %}
            {% with primary_image_found=False %}
            {% for image in vehicle_images %}
            {% if image.is_primary %}
            <img src="{{ image.image.url }}" alt="{{ image.get_image_type_display }} - {{ vehicle.vin }}"
              class="w-24 h-24 object-cover rounded-lg mr-6">
            {% with primary_image_found=True %}{% endwith %}
            {% endif %}
            {% endfor %}
            {% if not primary_image_found %}
            <!-- Use first available image if no primary image is set -->
            {% if vehicle_images.0 %}
            <img src="{{ vehicle_images.0.image.url }}"
              alt="{{ vehicle_images.0.get_image_type_display }} - {{ vehicle.vin }}"
              class="w-24 h-24 object-cover rounded-lg mr-6">
            {% else %}
            <!-- Fallback placeholder when images exist but can't be loaded -->
            <div class="w-24 h-24 bg-gray-200 rounded-lg mr-6 flex items-center justify-center">
              <i class="fas fa-car text-gray-400 text-2xl"></i>
            </div>
            {% endif %}
            {% endif %}
            {% endwith %}
            {% else %}
            <!-- No images available - show placeholder with clear indication -->
            <div
              class="w-24 h-24 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg mr-6 flex flex-col items-center justify-center">
              <i class="fas fa-image text-gray-400 text-lg mb-1"></i>
              <span class="text-xs text-gray-400">No Image</span>
            </div>
            {% endif %}
            <div>
              <h1 class="text-2xl font-semibold text-gray-800">{{ vehicle.make }} {{ vehicle.model }}</h1>
              <p class="text-gray-600">VIN: {{ vehicle.vin }} ({{ vehicle.manufacture_year }})</p>
            </div>
          </div>

          <!-- Vehicle Status Section -->
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-gray-800">Vehicle Status Overview</h2>
              <div class="text-sm text-gray-500 flex items-center">
                <i class="fas fa-question-circle mr-1"></i>
                <span>Color coding: Green = Good, Yellow = Caution, Red = Alert</span>
              </div>
            </div>

            <!-- Status Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <!-- Accident History -->
              <div
                class="flex items-center justify-center p-4 {% if status.accident_history == 'NHA' %}bg-green-100 border-green-300{% elif status.accident_history == 'CAD' %}bg-red-100 border-red-300{% else %}bg-yellow-100 border-yellow-300{% endif %} rounded-lg border">
                <div
                  class="text-xl {% if status.accident_history == 'NHA' %}text-green-600{% elif status.accident_history == 'CAD' %}text-red-600{% else %}text-yellow-600{% endif %}">
                  <i class="fas fa-car-crash"></i>
                </div>
                <div class="ml-4 text-center">
                  <p class="font-semibold text-gray-700">Accidents</p>
                  <p
                    class="{% if status.accident_history == 'NHA' %}text-green-600{% elif status.accident_history == 'CAD' %}text-red-600{% else %}text-yellow-600{% endif %} text-sm">
                    {{ status.get_accident_history_display }}
                  </p>
                </div>
              </div>

              <!-- Theft Status -->
              <div
                class="flex items-center justify-center p-4 {% if status.theft_involvement == 'NHT' %}bg-green-100 border-green-300{% elif status.theft_involvement == 'STI' %}bg-red-100 border-red-300{% else %}bg-yellow-100 border-yellow-300{% endif %} rounded-lg border">
                <div
                  class="text-xl {% if status.theft_involvement == 'NHT' %}text-green-600{% elif status.theft_involvement == 'STI' %}text-red-600{% else %}text-yellow-600{% endif %}">
                  <i class="fas fa-user-lock"></i>
                </div>
                <div class="ml-4 text-center">
                  <p class="font-semibold text-gray-700">Theft</p>
                  <p
                    class="{% if status.theft_involvement == 'NHT' %}text-green-600{% elif status.theft_involvement == 'STI' %}text-red-600{% else %}text-yellow-600{% endif %} text-sm">
                    {{ status.get_theft_involvement_display }}
                  </p>
                </div>
              </div>

              <!-- Odometer Status -->
              <div
                class="flex items-center justify-center p-4 {% if status.odometer_fraud == 'NOF' %}bg-green-100 border-green-300{% else %}bg-red-100 border-red-300{% endif %} rounded-lg border">
                <div
                  class="text-xl {% if status.odometer_fraud == 'NOF' %}text-green-600{% else %}text-red-600{% endif %}">
                  <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="ml-4 text-center">
                  <p class="font-semibold text-gray-700">Odometer</p>
                  <p
                    class="{% if status.odometer_fraud == 'NOF' %}text-green-600{% else %}text-red-600{% endif %} text-sm">
                    {{ status.get_odometer_fraud_display }}
                  </p>
                </div>
              </div>

              <!-- Legal Status -->
              <div
                class="flex items-center justify-center p-4 {% if status.legal_status == 'LG' %}bg-green-100 border-green-300{% else %}bg-red-100 border-red-300{% endif %} rounded-lg border">
                <div
                  class="text-xl {% if status.legal_status == 'LG' %}text-green-600{% else %}text-red-600{% endif %}">
                  <i class="fas fa-balance-scale"></i>
                </div>
                <div class="ml-4 text-center">
                  <p class="font-semibold text-gray-700">Legal Status</p>
                  <p
                    class="{% if status.legal_status == 'LG' %}text-green-600{% else %}text-red-600{% endif %} text-sm">
                    {{ status.get_legal_status_display }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Previous Owners Section -->
            <div class="bg-gray-50 rounded-lg p-4 border">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="text-2xl text-blue-600 mr-3">
                    <i class="fas fa-users"></i>
                  </div>
                  <div>
                    <p class="font-semibold text-gray-700">Previous Owners</p>
                    <p class="text-sm text-gray-500">Number of previous vehicle owners</p>
                  </div>
                </div>
                <div class="text-right">
                  <div
                    class="text-3xl font-bold {% if status.owner_history == 0 %}text-green-600{% elif status.owner_history <= 2 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {{ status.owner_history }}
                  </div>
                  <div
                    class="text-xs {% if status.owner_history == 0 %}text-green-600{% elif status.owner_history <= 2 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {% if status.owner_history == 0 %}
                    First Owner
                    {% elif status.owner_history == 1 %}
                    One Previous Owner
                    {% else %}
                    Multiple Owners
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Vehicle Images Section -->
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">Vehicle Images</h2>
              <div class="text-sm text-gray-500 flex items-center">
                <i class="fas fa-mouse-pointer mr-1"></i>
                <span>Click images to view in full size</span>
              </div>
            </div>
            {% if vehicle_images %}
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {% for image in vehicle_images %}
              <div class="relative group">
                <div class="aspect-w-4 aspect-h-3 bg-gray-100 rounded-lg overflow-hidden">
                  <img src="{{ image.image.url }}" alt="{{ image.get_image_type_display }} - {{ vehicle.vin }}"
                    class="w-full h-48 object-cover rounded-lg hover:scale-105 transition-transform duration-200 cursor-pointer"
                    onclick="openImageModal('{{ image.image.url }}', '{{ image.get_image_type_display }}', '{{ image.description|default:'' }}')">
                </div>
                <div class="mt-2 text-center">
                  <p class="text-sm font-medium text-gray-700">{{ image.get_image_type_display }}</p>
                  {% if image.is_primary %}
                  <span
                    class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mt-1">Primary</span>
                  {% endif %}
                  {% if image.description %}
                  <p class="text-xs text-gray-500 mt-1">{{ image.description }}</p>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <!-- No Images Found Message -->
            <div
              class="flex flex-col items-center justify-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
              <div class="text-6xl text-gray-400 mb-4">
                <i class="fas fa-image"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-700 mb-2">No Vehicle Images Available</h3>
              <p class="text-gray-500 text-center max-w-md">
                No images have been uploaded for this vehicle yet. Images may be added during future inspections or
                maintenance visits.
              </p>
              <div class="mt-4 flex items-center text-sm text-gray-400">
                <i class="fas fa-info-circle mr-2"></i>
                <span>Check back later for updated vehicle photos</span>
              </div>
            </div>
            {% endif %}
          </div>

          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">Identification and Technical Specifications</h2>
              <div class="text-sm text-gray-500 flex items-center">
                <i class="fas fa-id-card mr-1"></i>
                <span>Verify these details match your vehicle documentation</span>
              </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <p class="text-sm text-gray-500">Make</p>
                <p class="font-semibold">{{ vehicle.make }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Model</p>
                <p class="font-semibold">{{ vehicle.model }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Body type</p>
                <p class="font-semibold">{{ vehicle.body_type }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Manufacture year</p>
                <p class="font-semibold">{{ vehicle.manufacture_year }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Engine Code</p>
                <p class="font-semibold">{{ vehicle.engine_code }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Interior Color</p>
                <p class="font-semibold">{{ vehicle.interior_color }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Exterior Color</p>
                <p class="font-semibold">{{ vehicle.exterior_color }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Fuel Type</p>
                <p class="font-semibold">{{ vehicle.fuel_type }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Transmission Type</p>
                <p class="font-semibold">{{ vehicle.transmission_type }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Powertrain Displacement</p>
                <p class="font-semibold">{{ vehicle.powertrain_displacement }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Powertrain Power</p>
                <p class="font-semibold">{{ vehicle.powertrain_power }}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Plant Location</p>
                <p class="font-semibold">{{ vehicle.plant_location }}</p>
              </div>
            </div>
          </div>

          <div class="h-px w-100 bg-gray-100"></div>

          <!-- Equipment Section -->
          {% include "search/equipment.html" %}

          <!-- Inspections -->
          <div class="bg-white p-5 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-semibold text-gray-800">Inspections</h2>
              <button 
                id="toggleInspectionsBtn" 
                onclick="toggleInspections()"
                class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                <span id="toggleInspectionsText">Show Inspections</span>
                <i id="toggleInspectionsIcon" class="fas fa-chevron-down ml-2 transition-transform duration-200"></i>
              </button>
            </div>
            
            <!-- Help text for inspections -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
              <div class="flex items-start">
                <i class="fas fa-lightbulb text-green-600 mt-1 mr-2"></i>
                <div class="text-sm text-green-700">
                  <strong>About Inspections:</strong> These are official vehicle safety and emissions inspections conducted by certified facilities. 
                  Higher ratings indicate better vehicle condition. Regular inspections help ensure vehicle safety and compliance.
                </div>
              </div>
            </div>

            <!-- Summary when collapsed -->
            <div id="inspectionsSummary" class="mb-4">
              <div class="bg-gray-50 rounded-lg p-4 border">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <div class="text-2xl text-green-600 mr-3">
                      <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-700">Total Inspections</p>
                      <p class="text-sm text-gray-500">Click "Show Inspections" to view detailed records</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold text-green-600">
                      {{ inspections|length }}
                    </div>
                    <div class="text-xs text-green-600">
                      {% if inspections|length == 0 %}
                      No Inspections
                      {% elif inspections|length == 1 %}
                      Inspection Found
                      {% else %}
                      Inspections Found
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detailed inspections (initially hidden) -->
            <div id="inspectionsDetails" class="overflow-x-auto hidden">
              {% if inspections %}
                {% for inspection in inspections %}
                <div class="bg-white border border-gray-200 rounded-lg mb-4 p-4 shadow-sm">
                  <!-- Inspection Header -->
                  <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-100">
                    <div class="flex items-center">
                      <div class="bg-green-100 text-green-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-semibold mr-3">
                        {{ forloop.counter }}
                      </div>
                      <div>
                        <h4 class="font-semibold text-gray-800">{{ inspection.inspection_number }}</h4>
                        <p class="text-sm text-gray-500">
                          <i class="fas fa-calendar mr-1"></i>
                          {{ inspection.inspection_date|date:"F j, Y" }}
                        </p>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-lg font-semibold 
                        {% if inspection.inspection_result == 'PAS' %}text-green-600
                        {% elif inspection.inspection_result == 'PMD' or inspection.inspection_result == 'PJD' %}text-yellow-600
                        {% else %}text-red-600{% endif %}">
                        {{ inspection.get_inspection_result_display }}
                      </div>
                      <div class="text-xs text-gray-500">{{ inspection.year }}</div>
                    </div>
                  </div>

                  <!-- Inspection Details Grid -->
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <!-- Inspection Result -->
                    <div class="flex items-center">
                      <div class="{% if inspection.inspection_result == 'PAS' %}text-green-600
                        {% elif inspection.inspection_result == 'PMD' or inspection.inspection_result == 'PJD' %}text-yellow-600
                        {% else %}text-red-600{% endif %} mr-2">
                        <i class="fas fa-{% if inspection.inspection_result == 'PAS' %}check-circle{% elif inspection.inspection_result == 'PMD' or inspection.inspection_result == 'PJD' %}exclamation-triangle{% else %}times-circle{% endif %}"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">Inspection Result</p>
                        <p class="font-medium text-gray-700">{{ inspection.get_inspection_result_display }}</p>
                      </div>
                    </div>

                    <!-- Vehicle Health Index -->
                    <div class="flex items-center">
                      <div class="text-blue-600 mr-2">
                        <i class="fas fa-heartbeat"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">Vehicle Health Index</p>
                        <p class="font-medium text-gray-700">
                          {% if inspection.vehicle_health_index %}
                            {{ inspection.vehicle_health_index }}
                          {% else %}
                            Not Available
                          {% endif %}
                        </p>
                      </div>
                    </div>

                    <!-- PDF Report -->
                    <div class="flex items-center">
                      <div class="text-red-600 mr-2">
                        <i class="fas fa-file-pdf"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">Inspection Report</p>
                        <p class="font-medium text-gray-700">
                          {% if inspection.has_pdf %}
                            <button 
                              onclick="openInspectionPDF('{{ inspection.id }}', '{{ inspection.inspection_number }}')"
                              class="text-blue-600 hover:text-blue-800 underline text-sm">
                              <i class="fas fa-eye mr-1"></i>View PDF
                            </button>
                            <br><span class="text-xs text-gray-500">{{ inspection.pdf_file_size_mb }} MB</span>
                          {% else %}
                            <span class="text-gray-400">No PDF available</span>
                          {% endif %}
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- External Link Section -->
                  {% if inspection.link_to_results %}
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                    <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                      <i class="fas fa-external-link-alt text-blue-600 mr-2"></i>
                      External Inspection Results
                    </h5>
                    <a href="{{ inspection.link_to_results }}" 
                       target="_blank" 
                       class="text-blue-600 hover:text-blue-800 underline text-sm">
                      <i class="fas fa-link mr-1"></i>View External Results
                      <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                    </a>
                  </div>
                  {% endif %}

                  <!-- Detailed Inspection Form Link -->
                  {% if inspection.inspections_form %}
                  <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                    <div class="flex items-center justify-between">
                      <div>
                        <h5 class="font-semibold text-gray-700 mb-1 flex items-center">
                          <i class="fas fa-clipboard-list text-green-600 mr-2"></i>
                          50-Point Inspection Form
                        </h5>
                        <p class="text-sm text-gray-600">
                          Completion: {{ inspection.inspections_form.completion_percentage }}%
                          {% if inspection.inspections_form.is_completed %}
                            <span class="text-green-600 ml-2">
                              <i class="fas fa-check-circle"></i> Completed
                            </span>
                          {% else %}
                            <span class="text-yellow-600 ml-2">
                              <i class="fas fa-clock"></i> In Progress
                            </span>
                          {% endif %}
                        </p>
                        {% if inspection.inspections_form.technician %}
                        <p class="text-xs text-gray-500 mt-1">
                          Technician: {{ inspection.inspections_form.technician.first_name }} {{ inspection.inspections_form.technician.last_name }}
                        </p>
                        {% endif %}
                      </div>
                      <button 
                        onclick="openInspectionFormModal('{{ inspection.id }}', '{{ inspection.inspection_number }}')"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm">
                        <i class="fas fa-eye mr-1"></i>View Details
                      </button>
                    </div>
                  </div>
                  {% else %}
                  <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <p class="text-sm text-gray-600 flex items-center">
                      <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                      No detailed inspection form available for this record
                    </p>
                  </div>
                  {% endif %}

                  <!-- Inspection Metadata -->
                  <div class="mt-3 pt-3 border-t border-gray-100">
                    <div class="flex items-center justify-between text-xs text-gray-500">
                      <div class="flex items-center">
                        <i class="fas fa-clock mr-1"></i>
                        <span>
                          {% if inspection.created_at %}
                            Created: {{ inspection.created_at|date:"M j, Y" }}
                          {% endif %}
                          {% if inspection.updated_at and inspection.updated_at != inspection.created_at %}
                            | Updated: {{ inspection.updated_at|date:"M j, Y" }}
                          {% endif %}
                        </span>
                      </div>
                      {% if inspection.pdf_uploaded_at %}
                      <div class="flex items-center">
                        <i class="fas fa-upload mr-1"></i>
                        <span>PDF uploaded: {{ inspection.pdf_uploaded_at|date:"M j, Y" }}</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="flex flex-col items-center justify-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                  <div class="text-6xl text-gray-400 mb-4">
                    <i class="fas fa-clipboard-check"></i>
                  </div>
                  <h3 class="text-lg font-medium text-gray-700 mb-2">No Inspection Records Available</h3>
                  <p class="text-gray-500 text-center max-w-md">
                    No inspection records have been found for this vehicle. Inspections may be added when the vehicle undergoes official safety and emissions testing.
                  </p>
                  <div class="mt-4 flex items-center text-sm text-gray-400">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span>Check back after the next scheduled inspection</span>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          <!--End of Inspections-->

          <div class="h-px w-100 bg-gray-100"></div>

          <!-- Maintenance History -->
          <div class="bg-white p-5 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-semibold text-gray-800">Maintenance History</h2>
              <button 
                id="toggleMaintenanceBtn" 
                onclick="toggleMaintenanceHistory()"
                class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                <span id="toggleMaintenanceText">Show History</span>
                <i id="toggleMaintenanceIcon" class="fas fa-chevron-down ml-2 transition-transform duration-200"></i>
              </button>
            </div>
            
            <!-- Help text for maintenance -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
              <div class="flex items-start">
                <i class="fas fa-lightbulb text-blue-600 mt-1 mr-2"></i>
                <div class="text-sm text-blue-700">
                  <strong>About Maintenance History:</strong> These records show all documented maintenance work performed on the vehicle. 
                  Regular maintenance indicates good vehicle care and can help predict future reliability. Look for consistent service intervals and major repairs.
                </div>
              </div>
            </div>

            <!-- Summary when collapsed -->
            <div id="maintenanceSummary" class="mb-4">
              <div class="bg-gray-50 rounded-lg p-4 border">
                <div class="flex items-center justify-between">
                  <div class="flex items-center">
                    <div class="text-2xl text-blue-600 mr-3">
                      <i class="fas fa-wrench"></i>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-700">Total Maintenance Records</p>
                      <p class="text-sm text-gray-500">Click "Show History" to view detailed records</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold text-blue-600">
                      {{ maintenance_records|length }}
                    </div>
                    <div class="text-xs text-blue-600">
                      {% if maintenance_records|length == 0 %}
                      No Records
                      {% elif maintenance_records|length == 1 %}
                      Record Found
                      {% else %}
                      Records Found
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detailed maintenance history table (initially hidden) -->
            <div id="maintenanceDetails" class="overflow-x-auto hidden">
              {% if maintenance_records %}
                {% for record in maintenance_records %}
                <div class="bg-white border border-gray-200 rounded-lg mb-4 p-4 shadow-sm">
                  <!-- Record Header -->
                  <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-100">
                    <div class="flex items-center">
                      <div class="bg-blue-100 text-blue-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-semibold mr-3">
                        {{ forloop.counter }}
                      </div>
                      <div>
                        <h4 class="font-semibold text-gray-800">{{ record.work_done }}</h4>
                        <p class="text-sm text-gray-500">
                          <i class="fas fa-calendar mr-1"></i>
                          {{ record.date_performed|date:"F j, Y \a\t g:i A" }}
                        </p>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-lg font-semibold text-gray-700">{{ record.mileage|floatformat:0 }} mi</div>
                      <div class="text-xs text-gray-500">Mileage</div>
                    </div>
                  </div>

                  <!-- Record Details Grid -->
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <!-- Technician -->
                    <div class="flex items-center">
                      <div class="text-blue-600 mr-2">
                        <i class="fas fa-user-cog"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">Technician</p>
                        <p class="font-medium text-gray-700">
                          {% if record.technician %}
                            {{ record.technician.first_name }} {{ record.technician.last_name }}
                            {% if record.technician.email %}
                              <br><span class="text-xs text-gray-500">{{ record.technician.email }}</span>
                            {% endif %}
                          {% else %}
                            N/A
                          {% endif %}
                        </p>
                      </div>
                    </div>

                    <!-- Scheduled Maintenance -->
                    <div class="flex items-center">
                      <div class="text-green-600 mr-2">
                        <i class="fas fa-clipboard-check"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">Scheduled Maintenance</p>
                        <p class="font-medium text-gray-700">
                          {% if record.scheduled_maintenance %}
                            {{ record.scheduled_maintenance.maintenance_type }}
                          {% else %}
                            Unscheduled
                          {% endif %}
                        </p>
                      </div>
                    </div>

                    <!-- Service Image -->
                    <div class="flex items-center">
                      <div class="text-purple-600 mr-2">
                        <i class="fas fa-camera"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">Service Image</p>
                        <p class="font-medium text-gray-700">
                          {% if record.service_image %}
                            <button 
                              onclick="openMaintenanceImageModal('{{ record.service_image.url }}', '{{ record.image_type_display }}', '{{ record.image_description|default:'' }}', '{{ record.work_done }}')"
                              class="text-blue-600 hover:text-blue-800 underline text-sm">
                              <i class="fas fa-eye mr-1"></i>View Image
                            </button>
                            {% if record.image_type %}
                              <br><span class="text-xs text-gray-500">{{ record.image_type_display }}</span>
                            {% endif %}
                          {% else %}
                            <span class="text-gray-400">No image</span>
                          {% endif %}
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Parts Used Section -->
                  {% if record.parts_used.all %}
                  <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                      <i class="fas fa-cogs text-orange-600 mr-2"></i>
                      Parts Used
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                      {% for part_usage in record.parts_used.all %}
                      <div class="flex items-center justify-between bg-white rounded p-2 border">
                        <div>
                          <p class="font-medium text-gray-700">{{ part_usage.part.name }}</p>
                          <p class="text-xs text-gray-500">Qty: {{ part_usage.quantity }}</p>
                        </div>
                        {% if part_usage.unit_cost %}
                        <div class="text-right">
                          <p class="font-semibold text-gray-700">${{ part_usage.total_cost|floatformat:2 }}</p>
                          <p class="text-xs text-gray-500">${{ part_usage.unit_cost|floatformat:2 }} each</p>
                        </div>
                        {% endif %}
                      </div>
                      {% endfor %}
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-200">
                      <div class="text-center">
                        <span class="text-sm text-gray-600">
                          <i class="fas fa-info-circle mr-1"></i>
                          Individual part costs shown above
                        </span>
                      </div>
                    </div>
                  </div>
                  {% endif %}

                  <!-- Notes Section -->
                  {% if record.notes %}
                  <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                    <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                      <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>
                      Additional Notes
                    </h5>
                    <p class="text-gray-700 text-sm">{{ record.notes }}</p>
                  </div>
                  {% endif %}

                  <!-- Image Description -->
                  {% if record.image_description %}
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                      <i class="fas fa-image text-blue-600 mr-2"></i>
                      Image Description
                    </h5>
                    <p class="text-gray-700 text-sm">{{ record.image_description }}</p>
                  </div>
                  {% endif %}

                  <!-- Record Timestamps -->
                  <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between text-xs text-gray-400">
                    <span>
                      <i class="fas fa-plus-circle mr-1"></i>
                      Created: {{ record.created_at|date:"M j, Y g:i A" }}
                    </span>
                    {% if record.updated_at != record.created_at %}
                    <span>
                      <i class="fas fa-edit mr-1"></i>
                      Updated: {{ record.updated_at|date:"M j, Y g:i A" }}
                    </span>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="p-8 text-center text-gray-500">
                  <div class="flex flex-col items-center">
                    <i class="fas fa-clipboard-list text-4xl mb-3 text-gray-300"></i>
                    <h3 class="text-lg font-medium text-gray-600 mb-2">No Maintenance Records Found</h3>
                    <p class="text-gray-500 max-w-md">
                      No maintenance records have been documented for this vehicle yet. 
                      Regular maintenance records help track vehicle care and can indicate reliability.
                    </p>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>

        </div>

        <!-- Comprehensive Help Section -->
        <div class="mt-8 bg-gray-50 rounded-lg p-6 border">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-question-circle text-blue-600 mr-2"></i>
            How to Interpret This Report
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Status Indicators -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-traffic-light text-green-600 mr-2"></i>
                Status Color Guide
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                  <span><strong>Green:</strong> Good condition, no issues detected</span>
                </div>
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-yellow-500 rounded mr-2"></div>
                  <span><strong>Yellow:</strong> Caution, minor issues or unknown status</span>
                </div>
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                  <span><strong>Red:</strong> Alert, significant issues detected</span>
                </div>
              </div>
            </div>

            <!-- Key Metrics -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                Key Factors to Consider
              </h4>
              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Accident History:</strong> Check for any collision damage that may affect safety</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Owner Count:</strong> Fewer owners typically indicate better care</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Maintenance:</strong> Regular service indicates responsible ownership</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-dot-circle text-gray-400 mr-2 mt-1"></i>
                  <span><strong>Inspections:</strong> Recent passes show current roadworthiness</span>
                </div>
              </div>
            </div>

            <!-- What to Do Next -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-clipboard-list text-purple-600 mr-2"></i>
                Recommended Actions
              </h4>
              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Verify VIN matches vehicle documentation</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Review maintenance history for regular service</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Check for any red status indicators</span>
                </div>
                <div class="flex items-start">
                  <i class="fas fa-check text-green-500 mr-2 mt-1"></i>
                  <span>Consider professional inspection if purchasing</span>
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="bg-white rounded-lg p-4 border">
              <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-phone text-orange-600 mr-2"></i>
                Need Help?
              </h4>
              <div class="space-y-2 text-sm text-gray-600">
                <p>If you have questions about this report or need clarification on any information:</p>
                <div class="flex items-center">
                  <i class="fas fa-envelope text-blue-500 mr-2"></i>
                  <span>Contact our support team for assistance</span>
                </div>
                <div class="flex items-center">
                  <i class="fas fa-clock text-green-500 mr-2"></i>
                  <span>Reports are updated as new information becomes available</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Disclaimer -->
          <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start">
              <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-1"></i>
              <div class="text-sm text-yellow-800">
                <strong>Important:</strong> This report is based on available data and should be used as a reference tool. 
                Always conduct a thorough physical inspection and consider professional evaluation before making purchase decisions. 
                Information accuracy depends on data sources and reporting completeness.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Image Modal for larger view -->
  <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
    <div class="relative max-w-4xl max-h-full mx-4">
      <button onclick="closeImageModal()"
        class="absolute top-4 right-4 text-white text-2xl font-bold hover:text-gray-300 z-10">
        &times;
      </button>
      <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
      <div id="modalCaption" class="text-white text-center mt-4"></div>
    </div>
  </div>

  <script>
    function openImageModal(imageUrl, imageType, description) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalCaption = document.getElementById('modalCaption');

      modalImage.src = imageUrl;
      modalImage.alt = imageType;

      let caption = imageType;
      if (description) {
        caption += ' - ' + description;
      }
      modalCaption.textContent = caption;

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Handle image loading errors
    function handleImageError(img) {
      const placeholder = document.createElement('div');
      placeholder.className = 'w-full h-48 bg-gray-200 rounded-lg flex flex-col items-center justify-center text-gray-500';
      placeholder.innerHTML = '<i class="fas fa-exclamation-triangle text-2xl mb-2"></i><span class="text-sm">Image not available</span>';

      img.parentNode.replaceChild(placeholder, img);
    }

    // Add error handling to all vehicle images
    document.addEventListener('DOMContentLoaded', function () {
      const vehicleImages = document.querySelectorAll('img[alt*="VIN"]');
      vehicleImages.forEach(function (img) {
        img.onerror = function () {
          handleImageError(this);
        };
      });
    });

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Maintenance image modal function
    function openMaintenanceImageModal(imageUrl, imageType, description, workDone) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalCaption = document.getElementById('modalCaption');
      
      modalImage.src = imageUrl;
      modalImage.alt = `${imageType} - ${workDone}`;
      
      let caption = `${imageType} - ${workDone}`;
      if (description) {
        caption += '\n' + description;
      }
      modalCaption.textContent = caption;
      
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Close modal when clicking outside the image
    document.getElementById('imageModal').addEventListener('click', function (e) {
      if (e.target === this) {
        closeImageModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        closeImageModal();
      }
    });

    // Toggle maintenance history visibility
    function toggleMaintenanceHistory() {
      const details = document.getElementById('maintenanceDetails');
      const summary = document.getElementById('maintenanceSummary');
      const toggleText = document.getElementById('toggleMaintenanceText');
      const toggleIcon = document.getElementById('toggleMaintenanceIcon');
      
      if (details.classList.contains('hidden')) {
        // Show details, hide summary
        details.classList.remove('hidden');
        summary.classList.add('hidden');
        toggleText.textContent = 'Hide History';
        toggleIcon.classList.add('rotate-180');
      } else {
        // Hide details, show summary
        details.classList.add('hidden');
        summary.classList.remove('hidden');
        toggleText.textContent = 'Show History';
        toggleIcon.classList.remove('rotate-180');
      }
    }

    // Toggle inspections visibility
    function toggleInspections() {
      const details = document.getElementById('inspectionsDetails');
      const summary = document.getElementById('inspectionsSummary');
      const toggleText = document.getElementById('toggleInspectionsText');
      const toggleIcon = document.getElementById('toggleInspectionsIcon');
      
      if (details.classList.contains('hidden')) {
        // Show details, hide summary
        details.classList.remove('hidden');
        summary.classList.add('hidden');
        toggleText.textContent = 'Hide Inspections';
        toggleIcon.classList.add('rotate-180');
      } else {
        // Hide details, show summary
        details.classList.add('hidden');
        summary.classList.remove('hidden');
        toggleText.textContent = 'Show Inspections';
        toggleIcon.classList.remove('rotate-180');
      }
    }

    // Open inspection PDF in new window/tab
    function openInspectionPDF(inspectionId, inspectionNumber) {
      const url = `/maintenance-history/inspection/${inspectionId}/pdf/`;
      window.open(url, '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');
    }

    // Open inspection form details modal
    function openInspectionFormModal(inspectionId, inspectionNumber) {
      // Create modal HTML
      const modalHTML = `
        <div id="inspectionFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
              <h3 class="text-xl font-semibold text-gray-800">
                <i class="fas fa-clipboard-list text-green-600 mr-2"></i>
                Inspection Form Details - ${inspectionNumber}
              </h3>
              <button onclick="closeInspectionFormModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
              <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                <span class="ml-3 text-gray-600">Loading inspection details...</span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      document.body.style.overflow = 'hidden';
      
      // Load inspection form details via AJAX
      fetch(`/maintenance-history/inspection-form/ajax/${inspectionId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateInspectionFormModalContent(data.html);
          } else {
            updateInspectionFormModalContent(`
              <div class="text-center py-8">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                <p class="text-gray-600">Error loading inspection form details.</p>
                <p class="text-sm text-gray-500 mt-2">${data.error || 'Please try again later.'}</p>
              </div>
            `);
          }
        })
        .catch(error => {
          updateInspectionFormModalContent(`
            <div class="text-center py-8">
              <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
              <p class="text-gray-600">Error loading inspection form details.</p>
              <p class="text-sm text-gray-500 mt-2">Network error. Please check your connection and try again.</p>
            </div>
          `);
        });
    }

    // Update inspection form modal content
    function updateInspectionFormModalContent(html) {
      const modal = document.getElementById('inspectionFormModal');
      if (modal) {
        const contentDiv = modal.querySelector('.overflow-y-auto');
        if (contentDiv) {
          contentDiv.innerHTML = html;
        }
      }
    }

    // Close inspection form modal
    function closeInspectionFormModal() {
      const modal = document.getElementById('inspectionFormModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'inspectionFormModal') {
        closeInspectionFormModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('inspectionFormModal');
        if (modal) {
          closeInspectionFormModal();
        }
      }
    });
  </script>
</body>

</html>
{% endblock %}