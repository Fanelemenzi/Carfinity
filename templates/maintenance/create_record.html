{% load static %}

{% block content %}



<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&amp;display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'css\tailwind\tailwind.css' %}"/>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png"/>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer="defer"></script>
    
    <style>
      
      /* Visual feedback for form validation */
      .field-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1) !important;
        background-color: #fef2f2;
      }
      
      .field-success {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1) !important;
      }
      
      .field-error-message {
        animation: slideInError 0.3s ease-out;
      }
      
      @keyframes slideInError {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Compact validation popup styling */
      .validation-popup {
        position: relative;
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 1px solid #f87171;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        animation: slideInFade 0.4s ease-out;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
      
      .validation-popup-content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      
      .validation-popup-icon {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        color: #dc2626;
        margin-top: 1px;
      }
      
      .validation-popup-text {
        flex: 1;
        color: #7f1d1d;
        font-size: 14px;
        line-height: 1.4;
        font-weight: 500;
      }
      
      .validation-popup-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: #991b1b;
      }
      
      .validation-popup-list {
        margin: 0;
        padding-left: 16px;
        color: #7f1d1d;
      }
      
      .validation-popup-list li {
        margin-bottom: 2px;
      }
      
      /* Inline field error styling - more compact */
      .inline-error {
        display: flex;
        align-items: center;
        gap: 6px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 8px 12px;
        margin-top: 8px;
        font-size: 13px;
        color: #dc2626;
        animation: slideInError 0.3s ease-out;
      }
      
      .inline-error-icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }
      
      @keyframes slideInFade {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Form submission states */
      .form-submitting {
        pointer-events: none;
        opacity: 0.7;
      }
      
      .form-submitting .btn-submit {
        cursor: not-allowed;
      }
      
      /* Focus states for better accessibility */
      .form-field:focus-within {
        transform: translateY(-1px);
        transition: transform 0.2s ease;
      }
      
      /* Image upload section styling */
      .image-upload-section {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #bfdbfe;
      }
      
      .image-preview-container {
        animation: fadeInScale 0.3s ease-out;
      }
      
      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      
      /* File input styling enhancement */
      input[type="file"]::-webkit-file-upload-button {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border: none;
        border-radius: 6px;
        color: white;
        padding: 8px 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      input[type="file"]::-webkit-file-upload-button:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body class="antialiased bg-body text-body font-body">
    <div>
      <section class="py-20 md:py-40 bg-yellowGray-500">
        <div class="container px-4 mx-auto">
          <div class="max-w-4xl mx-auto text-center mb-32">
            <h1 class="text-6xl sm:text-7xl md:text-8xl font-heading font-semibold mb-12">Welcome</h1>
            <p class="text-2xl">1. Log every work done to the vehcile in cronological order.</p>
            <p class="text-2xl">2. PLease be clear, precise and straight to the point for improved clarity.</p>
          </div>

          <form method="post" action="" enctype="multipart/form-data" class="max-w-md xl:max-w-3xl mx-auto">
            {% csrf_token %}
            
            <!-- General Form Errors -->
            {% if form.non_field_errors %}
              <div class="validation-popup">
                <div class="validation-popup-content">
                  <svg class="validation-popup-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                  </svg>
                  <div class="validation-popup-text">
                    <div class="validation-popup-title">Please correct the following:</div>
                    {% if form.non_field_errors|length == 1 %}
                      {% for error in form.non_field_errors %}
                        {{ error }}
                      {% endfor %}
                    {% else %}
                      <ul class="validation-popup-list">
                        {% for error in form.non_field_errors %}
                          <li>{{ error }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endif %}
            <!-- Vehicle -->
            <div class="relative group px-8 pt-5 pb-4 mb-4 bg-gray-50 rounded-lg form-field {% if form.vehicle.errors %}border-2 border-red-300{% endif %}">
              <span class="hidden group-hover:block absolute top-0 left-0 ml-8 mt-2 text-2xs text-gray-300">Vehicle</span>
              {{ form.vehicle }}
              <div class="text-gray-500 text-xs mt-1">Select the vehicle for which this maintenance record applies.</div>
              {% if form.vehicle.errors %}
                {% for error in form.vehicle.errors %}
                  <div class="inline-error">
                    <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    {{ error }}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <!-- Scheduled Maintenance -->
            <div class="relative group px-8 pt-5 pb-4 mb-4 bg-gray-50 rounded-lg form-field {% if form.scheduled_maintenance.errors %}border-2 border-red-300{% endif %}">
              <span class="hidden group-hover:block absolute top-0 left-0 ml-8 mt-2 text-2xs text-gray-300">Scheduled Maintenance</span>
              {{ form.scheduled_maintenance }}
              <div class="text-gray-500 text-xs mt-1">Choose the scheduled maintenance task (filtered by vehicle).</div>
              {% if form.scheduled_maintenance.errors %}
                {% for error in form.scheduled_maintenance.errors %}
                  <div class="inline-error">
                    <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    {{ error }}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <!-- Work Done -->
            <div class="relative group px-8 pt-5 pb-4 mb-4 bg-gray-50 rounded-lg form-field {% if form.work_done.errors %}border-2 border-red-300{% endif %}">
              <span class="hidden group-hover:block absolute top-0 left-0 ml-8 mt-2 text-2xs text-gray-300">Work Done</span>
              {{ form.work_done }}
              <div class="text-gray-500 text-xs mt-1">
                <strong>Be specific and detailed:</strong> Include parts replaced, procedures followed, and any findings.<br>
                <strong>Example:</strong> "Replaced front brake pads (OEM spec), inspected rotors (good condition), bled brake system, test drive completed - braking performance normal"
              </div>
              {% if form.work_done.errors %}
                {% for error in form.work_done.errors %}
                  <div class="inline-error">
                    <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    {{ error }}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <!-- Mileage -->
            <div class="relative group px-8 pt-5 pb-4 mb-4 bg-gray-50 rounded-lg form-field {% if form.mileage.errors %}border-2 border-red-300{% endif %}">
              <span class="hidden group-hover:block absolute top-0 left-0 ml-8 mt-2 text-2xs text-gray-300">Mileage</span>
              {{ form.mileage }}
              <div class="text-gray-500 text-xs mt-1">
                <strong>Record exact odometer reading:</strong> This helps track service intervals and warranty coverage.<br>
                <strong>Important:</strong> Double-check the reading - accurate mileage is crucial for maintenance scheduling.
              </div>
              {% if form.mileage.errors %}
                {% for error in form.mileage.errors %}
                  <div class="inline-error">
                    <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    {{ error }}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <!-- Notes -->
            <div class="relative group px-8 pt-5 pb-4 mb-4 bg-gray-50 rounded-lg form-field {% if form.notes.errors %}border-2 border-red-300{% endif %}">
              <span class="hidden group-hover:block absolute top-0 left-0 ml-8 mt-2 text-2xs text-gray-300">Notes</span>
              {{ form.notes }}
              <div class="text-gray-500 text-xs mt-1">Additional notes or observations (optional).</div>
              {% if form.notes.errors %}
                {% for error in form.notes.errors %}
                  <div class="inline-error">
                    <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    {{ error }}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <!-- Service Image Upload Section -->
            <div class="mb-8 p-6 image-upload-section rounded-lg">
              <h3 class="text-lg font-semibold text-blue-900 mb-3">Service Documentation (Optional)</h3>
              
              <!-- Help Text for Technicians -->
              <div class="bg-blue-100 border-l-4 border-blue-400 p-4 mb-6">
                <div class="mb-3">
                  <h4 class="text-sm font-semibold text-blue-800 mb-2">üì∏ Why Document Your Work?</h4>
                  <p class="text-blue-700 text-sm leading-relaxed">
                    Adding photos helps create a complete maintenance record, provides proof of work completed, 
                    and assists future technicians who may work on this vehicle.
                  </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <div>
                    <h5 class="text-xs font-semibold text-blue-800 mb-1">üìã Best Practices:</h5>
                    <ul class="text-xs text-blue-700 space-y-1">
                      <li>‚Ä¢ Take clear, well-lit photos</li>
                      <li>‚Ä¢ Show before/after conditions</li>
                      <li>‚Ä¢ Include part numbers when visible</li>
                      <li>‚Ä¢ Document any damage found</li>
                    </ul>
                  </div>
                  <div>
                    <h5 class="text-xs font-semibold text-blue-800 mb-1">üîß What to Photograph:</h5>
                    <ul class="text-xs text-blue-700 space-y-1">
                      <li>‚Ä¢ Replaced parts and components</li>
                      <li>‚Ä¢ Work area before starting</li>
                      <li>‚Ä¢ Completed repair/service</li>
                      <li>‚Ä¢ Any issues discovered</li>
                    </ul>
                  </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-md">
                  <p class="text-xs text-blue-600">
                    <strong>üí° Pro Tip:</strong> Good documentation protects both you and the customer by providing 
                    clear evidence of professional work completed according to standards.
                  </p>
                </div>
              </div>
              
              <!-- Service Image Upload -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  üì∑ Upload Service Photo
                </label>
                <div class="relative group px-6 pt-4 pb-4 bg-white rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 transition-colors duration-200 form-field {% if form.service_image.errors %}border-red-300{% endif %}">
                  {{ form.service_image }}
                  <div class="text-gray-500 text-xs mt-2">
                    <strong>Supported formats:</strong> JPEG, PNG, GIF, WebP (max 10MB)<br>
                    <strong>Recommended:</strong> Clear, well-lit photos showing the work performed
                  </div>
                  {% if form.service_image.errors %}
                    {% for error in form.service_image.errors %}
                      <div class="inline-error">
                        <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ error }}
                      </div>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>

              <!-- Image Type Selection -->
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  üè∑Ô∏è Photo Category
                </label>
                <div class="relative group px-6 pt-4 pb-4 bg-white rounded-lg border border-gray-300 form-field {% if form.image_type.errors %}border-2 border-red-300{% endif %}">
                  {{ form.image_type }}
                  <div class="text-gray-500 text-xs mt-2">
                    <strong>Choose the category that best describes your photo:</strong><br>
                    ‚Ä¢ <strong>Before Service:</strong> Condition before work started<br>
                    ‚Ä¢ <strong>During Service:</strong> Work in progress<br>
                    ‚Ä¢ <strong>After Service:</strong> Completed work<br>
                    ‚Ä¢ <strong>Parts/Components:</strong> New or replaced parts<br>
                    ‚Ä¢ <strong>Damage/Issue Found:</strong> Problems discovered during service
                  </div>
                  {% if form.image_type.errors %}
                    {% for error in form.image_type.errors %}
                      <div class="inline-error">
                        <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ error }}
                      </div>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>

              <!-- Image Description -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  üìù Photo Description
                </label>
                <div class="relative group px-6 pt-4 pb-4 bg-white rounded-lg border border-gray-300 form-field {% if form.image_description.errors %}border-2 border-red-300{% endif %}">
                  {{ form.image_description }}
                  <div class="text-gray-500 text-xs mt-2">
                    <strong>Examples:</strong> "Replaced brake pads - front left", "Oil leak found near engine block", 
                    "New air filter installed", "Completed tire rotation"
                  </div>
                  {% if form.image_description.errors %}
                    {% for error in form.image_description.errors %}
                      <div class="inline-error">
                        <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ error }}
                      </div>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>



            <div class="text-center">
              <button type="submit" class="group relative inline-block h-16 mb-8 w-full md:w-44 bg-blueGray-900 rounded">
                <div class="absolute top-0 left-0 transform -translate-y-1 -translate-x-1 w-full h-full group-hover:translate-y-0 group-hover:translate-x-0 transition duration-300">
                  <div class="flex h-full w-full items-center justify-center bg-blue-500 border-2 border-blueGray-900 rounded">
                    <span class="text-base font-semibold uppercase">Save Record</span>
                  </div>
                </div>
              </button>
            </div>
          </form>
          
          <!-- Form Validation and AJAX Scripts -->
          <script>
          // Vehicle-based scheduled maintenance filtering
          document.getElementById('id_vehicle').addEventListener('change', function() {
            const vehicleId = this.value;
            const scheduledField = document.getElementById('id_scheduled_maintenance');
            
            if (vehicleId) {
              fetch(`/api/scheduled-maintenance/?vehicle=${vehicleId}`)
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
                })
                .then(data => {
                  // Clear existing options
                  scheduledField.innerHTML = '<option value="">Select scheduled maintenance...</option>';
                  
                  // Add new options
                  if (Array.isArray(data) && data.length > 0) {
                    data.forEach(item => {
                      const option = document.createElement('option');
                      option.value = item.id;
                      option.textContent = `${item.task_name} - Due: ${item.due_date}`;
                      scheduledField.appendChild(option);
                    });
                  } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No scheduled maintenance found';
                    option.disabled = true;
                    scheduledField.appendChild(option);
                  }
                })
                .catch(error => {
                  console.error('Error fetching scheduled maintenance:', error);
                  scheduledField.innerHTML = '<option value="">Error loading maintenance tasks</option>';
                });
            } else {
              // Reset to default when no vehicle selected
              scheduledField.innerHTML = '<option value="">Select a vehicle first</option>';
            }
          });

          // Enhanced form validation
          document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const submitButton = form.querySelector('button[type="submit"]');
            
            // Real-time field validation
            const requiredFields = ['id_vehicle', 'id_work_done', 'id_mileage'];
            
            requiredFields.forEach(fieldId => {
              const field = document.getElementById(fieldId);
              if (field) {
                field.addEventListener('blur', function() {
                  validateField(this);
                });
                
                field.addEventListener('input', function() {
                  clearFieldError(this);
                });
              }
            });
            
            // Form submission validation
            form.addEventListener('submit', function(e) {
              let isValid = true;
              const errors = [];
              
              // Validate required fields
              requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !validateField(field)) {
                  isValid = false;
                }
              });
              
              // Validate mileage is a positive number
              const mileageField = document.getElementById('id_mileage');
              if (mileageField && mileageField.value) {
                const mileage = parseInt(mileageField.value);
                if (isNaN(mileage) || mileage < 0) {
                  showFieldError(mileageField, 'Mileage must be a positive number');
                  isValid = false;
                }
              }
              

              
              // Show general form errors if any
              if (errors.length > 0) {
                showFormErrors(errors);
              }
              
              if (!isValid) {
                e.preventDefault();
                
                // Scroll to first error
                const firstError = form.querySelector('.field-error');
                if (firstError) {
                  firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return false;
              }
              
              // Show loading state
              showSubmitLoading();
            });
            
            function validateField(field) {
              const value = field.value.trim();
              const fieldName = getFieldDisplayName(field);
              
              if (field.hasAttribute('required') || requiredFields.includes(field.id)) {
                if (!value) {
                  showFieldError(field, `${fieldName} is required`);
                  return false;
                }
              }
              
              clearFieldError(field);
              return true;
            }
            
            function showFieldError(field, message) {
              clearFieldError(field);
              
              field.classList.add('field-error');
              field.classList.remove('field-success');
              
              // Create error message element with new styling
              const errorDiv = document.createElement('div');
              errorDiv.className = 'inline-error';
              errorDiv.innerHTML = `
                <svg class="inline-error-icon" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                ${message}
              `;
              
              // Insert after the field
              field.parentNode.appendChild(errorDiv);
            }
            
            function clearFieldError(field) {
              field.classList.remove('field-error');
              field.classList.add('field-success');
              
              // Remove existing error message
              const existingError = field.parentNode.querySelector('.inline-error');
              if (existingError) {
                existingError.remove();
              }
            }
            
            function getFieldDisplayName(field) {
              const labels = {
                'id_vehicle': 'Vehicle',
                'id_scheduled_maintenance': 'Scheduled Maintenance',
                'id_work_done': 'Work Done',
                'id_mileage': 'Mileage',
                'id_notes': 'Notes',
                'id_service_image': 'Service Image',
                'id_image_type': 'Image Type',
                'id_image_description': 'Image Description'
              };
              return labels[field.id] || 'Field';
            }
            
            function showFormErrors(errors) {
              // Create or update general error container
              let errorContainer = document.getElementById('form-errors');
              if (!errorContainer) {
                errorContainer = document.createElement('div');
                errorContainer.id = 'form-errors';
                errorContainer.className = 'validation-popup';
                
                // Insert before the submit button
                const submitContainer = form.querySelector('.text-center');
                form.insertBefore(errorContainer, submitContainer);
              }
              
              const errorList = errors.length === 1 ? 
                errors[0] : 
                `<ul class="validation-popup-list">${errors.map(error => `<li>${error}</li>`).join('')}</ul>`;
              
              errorContainer.innerHTML = `
                <div class="validation-popup-content">
                  <svg class="validation-popup-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                  </svg>
                  <div class="validation-popup-text">
                    <div class="validation-popup-title">Please correct the following:</div>
                    ${errorList}
                  </div>
                </div>
              `;
              
              // Scroll to error container
              errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            function showSubmitLoading() {
              const buttonContent = submitButton.querySelector('div div');
              const originalText = buttonContent.innerHTML;
              
              // Add loading class to button
              submitButton.classList.add('loading');
              form.classList.add('form-submitting');
              
              buttonContent.innerHTML = `
                <div class="flex items-center justify-center">
                  <div class="loading-spinner"></div>
                  <span class="text-base font-semibold uppercase">Saving...</span>
                </div>
              `;
              
              submitButton.disabled = true;
              
              // Add loading overlay to form
              const loadingOverlay = document.createElement('div');
              loadingOverlay.className = 'loading-overlay';
              loadingOverlay.innerHTML = `
                <div class="loading-content">
                  <div class="loading-spinner"></div>
                  <div class="loading-text">Saving maintenance record...</div>
                </div>
              `;
              form.style.position = 'relative';
              form.appendChild(loadingOverlay);
              
              // Restore original state after 10 seconds (fallback)
              setTimeout(() => {
                buttonContent.innerHTML = originalText;
                submitButton.disabled = false;
                submitButton.classList.remove('loading');
                form.classList.remove('form-submitting');
                if (loadingOverlay.parentNode) {
                  loadingOverlay.parentNode.removeChild(loadingOverlay);
                }
              }, 10000);
            }
            
            // Preserve form state on page reload (for validation errors)
            window.addEventListener('beforeunload', function() {
              const formData = new FormData(form);
              const formState = {};
              
              for (let [key, value] of formData.entries()) {
                formState[key] = value;
              }
              

              
              sessionStorage.setItem('maintenanceFormState', JSON.stringify(formState));
            });
            
            // Initialize scheduled maintenance field
            const scheduledField = document.getElementById('id_scheduled_maintenance');
            if (scheduledField && scheduledField.options.length === 0) {
              scheduledField.innerHTML = '<option value="">Select a vehicle first</option>';
            }
            
            // Image upload preview functionality
            const imageInput = document.getElementById('id_service_image');
            if (imageInput) {
              imageInput.addEventListener('change', function(e) {
                handleImagePreview(e.target);
              });
            }
            
            // Restore form state on page load or after validation errors
            const savedState = sessionStorage.getItem('maintenanceFormState');
            
            if (savedState) {
              // Restore from session storage (normal page reload)
              try {
                const formState = JSON.parse(savedState);
                
                // Restore form fields
                Object.keys(formState).forEach(key => {
                  const field = form.querySelector(`[name="${key}"]`);
                  if (field && formState[key]) {
                    field.value = formState[key];
                  }
                });
                
                // Clear saved state after restoration
                sessionStorage.removeItem('maintenanceFormState');
              } catch (error) {
                console.error('Error restoring form state:', error);
              }
            }
            
            // Image preview functionality
            function handleImagePreview(input) {
              const file = input.files[0];
              const previewContainer = document.getElementById('image-preview-container');
              
              // Remove existing preview
              if (previewContainer) {
                previewContainer.remove();
              }
              
              if (file) {
                // Validate file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                  showFieldError(input, 'Image file size cannot exceed 10MB.');
                  input.value = '';
                  return;
                }
                
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                  showFieldError(input, 'Only JPEG, PNG, GIF, and WebP images are allowed.');
                  input.value = '';
                  return;
                }
                
                // Clear any existing errors
                clearFieldError(input);
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                  const previewDiv = document.createElement('div');
                  previewDiv.id = 'image-preview-container';
                  previewDiv.className = 'mt-4 p-4 bg-gray-50 rounded-lg border';
                  previewDiv.innerHTML = `
                    <div class="flex items-start space-x-4">
                      <img src="${e.target.result}" alt="Image preview" class="w-32 h-32 object-cover rounded-lg border">
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">Image Preview</h4>
                        <p class="text-sm text-gray-600 mt-1">File: ${file.name}</p>
                        <p class="text-sm text-gray-600">Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        <button type="button" onclick="removeImagePreview()" class="mt-2 text-sm text-red-600 hover:text-red-800">
                          Remove Image
                        </button>
                      </div>
                    </div>
                  `;
                  
                  // Insert preview after the image input field
                  input.parentNode.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
              }
            }
            
            function removeImagePreview() {
              const imageInput = document.getElementById('id_service_image');
              const previewContainer = document.getElementById('image-preview-container');
              
              if (imageInput) {
                imageInput.value = '';
              }
              if (previewContainer) {
                previewContainer.remove();
              }
            }
          });
          </script>


        </div>
      </section>
    </div>
  </body>
</html>

{% endblock %}