{% extends 'base/base.html' %}
{% load static %}

{% block title %}Generate Assessment Report - Carfinity{% endblock %}

{% block content %}
<br></br>
{% if user.is_authenticated %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Assessment Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#374151',
                        accent: '#f59e0b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-file-pdf text-danger mr-2"></i>
                            Generate Assessment Report
                        </h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-user mr-1"></i>
                        {{ user.get_full_name|default:user.username }}
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Card -->
        <div class="bg-white rounded-lg shadow p-6 border border-gray-200 mb-8">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                        Generate Assessment Report
                    </h2>
                    <p class="text-gray-600">Create a comprehensive report for this assessment</p>
                </div>
            </div>
        </div>

        <!-- Assessment Info -->
        <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-red-600 mr-2"></i>
                    <div>
                        <h3 class="text-sm font-medium text-red-800">Assessment: {{ assessment.assessment_id }}</h3>
                        <p class="text-sm text-red-700">Organization: {{ assessment.organization.name }}</p>
                        <p class="text-sm text-red-700">Vehicle: {{ assessment.vehicle }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-red-700">Status: <span class="font-medium">{{ assessment.get_status_display
                            }}</span></p>
                </div>
            </div>
        </div>

        <!-- Assessment Summary Card -->
        <div class="bg-white rounded-lg shadow border border-gray-200 mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-chart-bar mr-2"></i>Assessment Summary
                </h3>
                <p class="text-sm text-gray-500">Key findings and metrics from the assessment</p>
            </div>
            <div class="px-6 py-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <div class="text-center p-4 bg-blue-50 rounded-lg border">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-building text-blue-600"></i>
                        </div>
                        <h4 class="text-sm font-medium text-gray-700">Organization</h4>
                        <p class="text-lg font-bold text-gray-900">{{ assessment.organization.name|default:"Not specified" }}</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg border">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-car text-purple-600"></i>
                        </div>
                        <h4 class="text-sm font-medium text-gray-700">Vehicle</h4>
                        <p class="text-lg font-bold text-gray-900">{{ assessment.vehicle|default:"Not specified" }}</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg border">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <h4 class="text-sm font-medium text-gray-700">Severity</h4>
                        <p class="text-lg font-bold text-gray-900">{{
                            assessment.get_overall_severity_display|default:"Not assessed" }}</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg border">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-dollar-sign text-green-600"></i>
                        </div>
                        <h4 class="text-sm font-medium text-gray-700">Repair Cost</h4>
                        <p class="text-lg font-bold text-gray-900">${{
                            assessment.estimated_repair_cost|floatformat:2|default:"TBD" }}</p>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg border">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-calendar text-yellow-600"></i>
                        </div>
                        <h4 class="text-sm font-medium text-gray-700">Assessment Date</h4>
                        <p class="text-lg font-bold text-gray-900">{{ assessment.assessment_date|date:"M d, Y" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pre-filled Content Suggestions -->
        <div class="bg-white rounded-lg shadow border border-gray-200 mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-magic mr-2"></i>Auto-Generated Content Suggestions
                </h3>
                <p class="text-sm text-gray-500">Click to use pre-filled content based on assessment data</p>
            </div>
            <div class="px-6 py-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button type="button" onclick="fillExecutiveSummary()"
                        class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-left">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                            <span class="font-medium">Executive Summary</span>
                        </div>
                        <p class="text-sm text-gray-600">Auto-generate executive summary from assessment data</p>
                    </button>
                    <button type="button" onclick="fillDetailedFindings()"
                        class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-left">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-search text-green-600 mr-2"></i>
                            <span class="font-medium">Detailed Findings</span>
                        </div>
                        <p class="text-sm text-gray-600">Generate detailed findings from damage assessments</p>
                    </button>
                    <button type="button" onclick="fillRecommendations()"
                        class="p-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-left">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                            <span class="font-medium">Recommendations</span>
                        </div>
                        <p class="text-sm text-gray-600">Generate recommendations based on severity and cost</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- Form -->
        <form method="post" class="space-y-8">
            {% csrf_token %}

            <!-- Report Configuration -->
            <div class="bg-white rounded-lg shadow border border-gray-200 mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Report Configuration</h3>
                    <p class="text-sm text-gray-500">Configure report type and basic information</p>
                </div>
                <div class="px-6 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Report Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-file-alt mr-1"></i>Report Type
                            </label>
                            {{ form.report_type }}
                        </div>

                        <!-- Title -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-heading mr-1"></i>Report Title
                            </label>
                            {{ form.title }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Content -->
            <div class="bg-white rounded-lg shadow border border-gray-200 mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Report Content</h3>
                    <p class="text-sm text-gray-500">Provide detailed content for the report</p>
                </div>
                <div class="px-6 py-6">
                    <div class="space-y-6">
                        <!-- Executive Summary -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-file-alt mr-1"></i>Executive Summary
                            </label>
                            {{ form.executive_summary }}
                            <p class="mt-1 text-sm text-gray-500">High-level overview of the assessment findings and
                                conclusions</p>
                        </div>

                        <!-- Detailed Findings -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-search mr-1"></i>Detailed Findings
                            </label>
                            {{ form.detailed_findings }}
                            <p class="mt-1 text-sm text-gray-500">Comprehensive technical analysis of all assessed
                                components</p>
                        </div>

                        <!-- Recommendations -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lightbulb mr-1"></i>Professional Recommendations
                            </label>
                            {{ form.recommendations }}
                            <p class="mt-1 text-sm text-gray-500">Professional recommendations and next steps based on
                                assessment results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Options -->
            <div class="bg-white rounded-lg shadow border border-gray-200 mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-cog mr-2"></i>Report Options
                    </h3>
                    <p class="text-sm text-gray-500">Additional options for report generation</p>
                </div>
                <div class="px-6 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="include_photos" name="include_photos" checked
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="include_photos" class="ml-2 text-sm text-gray-700">Include assessment
                                    photos</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="include_financial" name="include_financial" checked
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="include_financial" class="ml-2 text-sm text-gray-700">Include financial
                                    analysis</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="include_damage_matrix" name="include_damage_matrix" checked
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="include_damage_matrix" class="ml-2 text-sm text-gray-700">Include damage
                                    assessment matrix</label>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="include_recommendations" name="include_recommendations"
                                    checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="include_recommendations" class="ml-2 text-sm text-gray-700">Include repair
                                    recommendations</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="include_signature" name="include_signature" checked
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="include_signature" class="ml-2 text-sm text-gray-700">Include assessor
                                    signature</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="watermark" name="watermark"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="watermark" class="ml-2 text-sm text-gray-700">Add watermark to
                                    report</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-between items-center space-x-4">
                <a href="{% url 'assessments:assessment_detail' assessment.id %}"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Assessment
                </a>
                <div class="flex space-x-4">
                    <button type="button" onclick="previewReport()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-eye mr-2"></i>Preview Report
                    </button>
                    <button type="submit"
                        class="bg-danger hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-file-pdf mr-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </form>

        <!-- Report Templates Guide -->
        <div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-info-circle text-red-600 mr-2"></i>Report Types Guide
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h4 class="text-md font-medium text-gray-900 mb-3">Insurance Report</h4>
                    <ul class="space-y-1 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Comprehensive damage assessment</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Financial analysis and recommendations</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Photos and documentation</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-md font-medium text-gray-900 mb-3">Technical Report</h4>
                    <ul class="space-y-1 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Detailed technical findings</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Component-by-component analysis</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Repair specifications</span>
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-md font-medium text-gray-900 mb-3">Summary Report</h4>
                    <ul class="space-y-1 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Executive summary only</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Key findings and recommendations</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-2 mt-0.5"></i>
                            <span>Concise format for quick review</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

{% else %}
{% include "dashboard/login_dashboard.html" %}
{% endif %}
{% endblock %}
<scri pt>
    // Auto-fill functions for report content
    function fillExecutiveSummary() {
    const executiveSummary = `
    EXECUTIVE SUMMARY

    Assessment ID: {{ assessment.assessment_id }}
    Organization: {{ assessment.organization.name|default:"Not specified" }}
    Vehicle: {{ assessment.vehicle }}
    Assessment Date: {{ assessment.assessment_date|date:"F d, Y" }}
    Assessor: {{ assessment.assessor_name|default:"Not specified" }}

    This comprehensive vehicle assessment was conducted to evaluate the extent of damage and determine the appropriate
    course of action. The assessment covered all major vehicle systems including exterior body components, mechanical
    systems, electrical systems, safety features, and structural integrity.

    KEY FINDINGS:
    - Overall Severity: {{ assessment.get_overall_severity_display|default:"To be determined" }}
    - Primary Damage Areas: {% if assessment.incident_location %}Incident occurred at {{ assessment.incident_location
    }}{% else %}Multiple areas assessed{% endif %}
    - Estimated Repair Cost: ${{ assessment.estimated_repair_cost|floatformat:2|default:"To be determined" }}
    - Vehicle Market Value: ${{ assessment.vehicle_market_value|floatformat:2|default:"To be determined" }}

    {% if assessment.estimated_repair_cost and assessment.vehicle_market_value %}
    FINANCIAL ANALYSIS:
    The repair cost represents {{ assessment.estimated_repair_cost|floatformat:0 }}% of the vehicle's market value. {%
    if assessment.estimated_repair_cost > assessment.vehicle_market_value|mul:0.7 %}Based on the 70% rule, this vehicle
    may be considered a total loss.{% else %}The vehicle is economically repairable.{% endif %}
    {% endif %}

    RECOMMENDATION:
    {% if assessment.overall_severity == 'total_loss' %}
    Based on the assessment findings, this vehicle is recommended for total loss classification due to the extent of
    damage and repair costs exceeding economic thresholds.
    {% elif assessment.overall_severity == 'severe' %}
    While the damage is extensive, repair is possible with proper attention to safety-critical components and structural
    integrity.
    {% else %}
    The vehicle can be repaired to restore it to safe operating condition with appropriate repairs to the identified
    damage areas.
    {% endif %}
    `.trim();

    document.getElementById('id_executive_summary').value = executiveSummary;
    }

    function fillDetailedFindings() {
    const detailedFindings = `
    DETAILED ASSESSMENT FINDINGS

    1. EXTERIOR BODY ASSESSMENT
    The exterior body components were systematically evaluated for damage severity and repair requirements. Assessment
    covered front-end components, side panels, rear-end components, and roof/pillar structures.

    Key Findings:
    - Front-end damage assessment completed
    - Side panel evaluation conducted
    - Rear-end components inspected
    - Roof and pillar integrity verified

    2. MECHANICAL SYSTEMS EVALUATION
    All major mechanical systems were assessed for functionality and damage:
    - Engine and powertrain components
    - Suspension and steering systems
    - Brake system integrity
    - Exhaust system condition

    3. ELECTRICAL SYSTEMS TESTING
    Comprehensive electrical system testing was performed:
    - Lighting systems functionality verified
    - Power accessories tested
    - Warning systems checked
    - Electronic control modules assessed

    4. SAFETY SYSTEMS VERIFICATION
    Critical safety systems were evaluated for proper operation:
    - Airbag system status verified
    - ABS and stability control systems tested
    - Seatbelt mechanisms inspected
    - Emergency brake functionality confirmed

    5. STRUCTURAL INTEGRITY ASSESSMENT
    Frame and structural components were thoroughly inspected:
    - Frame rails and cross-members examined
    - Floor pan integrity verified
    - Door jamb alignment checked
    - Structural mounting points assessed

    6. FLUID SYSTEMS INSPECTION
    All vehicle fluid systems were checked for leaks and contamination:
    - Engine oil condition and level
    - Transmission fluid status
    - Brake fluid integrity
    - Coolant system evaluation

    The assessment methodology followed industry-standard practices and utilized appropriate diagnostic equipment to
    ensure accurate evaluation of all vehicle systems.
    `.trim();

    document.getElementById('id_detailed_findings').value = detailedFindings;
    }

    function fillRecommendations() {
    let recommendations = `
    PROFESSIONAL RECOMMENDATIONS

    Based on the comprehensive assessment findings, the following recommendations are provided:

    IMMEDIATE ACTIONS REQUIRED:
    `;

    {% if assessment.overall_severity == 'severe' or assessment.overall_severity == 'total_loss' %}
    recommendations += `
    - Vehicle should not be operated until repairs are completed
    - Towing is recommended for vehicle transportation
    - Professional repair facility consultation required
    `;
    {% else %}
    recommendations += `
    - Vehicle may be operated with caution pending repairs
    - Address safety-critical issues as priority
    - Schedule repairs at qualified facility
    `;
    {% endif %}

    recommendations += `

    REPAIR PRIORITIES:
    1. Safety-critical systems (brakes, steering, airbags)
    2. Structural integrity issues
    3. Electrical system malfunctions
    4. Mechanical system repairs
    5. Cosmetic damage restoration

    FINANCIAL CONSIDERATIONS:
    `;

    {% if assessment.estimated_repair_cost and assessment.vehicle_market_value %}
    {% if assessment.estimated_repair_cost > assessment.vehicle_market_value|mul:0.7 %}
    recommendations += `
    - Repair costs exceed 70% of vehicle value
    - Consider total loss settlement
    - Evaluate salvage value options
    - Review insurance policy coverage
    `;
    {% else %}
    recommendations += `
    - Repair is economically viable
    - Obtain detailed repair estimates
    - Consider OEM vs aftermarket parts
    - Verify insurance coverage limits
    `;
    {% endif %}
    {% else %}
    recommendations += `
    - Obtain detailed repair cost estimates
    - Verify current market value
    - Review insurance policy terms
    - Consider repair vs replacement options
    `;
    {% endif %}

    recommendations += `

    QUALITY ASSURANCE:
    - Use certified repair facilities
    - Require OEM or equivalent parts
    - Ensure proper repair documentation
    - Conduct post-repair inspection

    FOLLOW-UP ACTIONS:
    - Schedule re-inspection after repairs
    - Maintain repair documentation
    - Update vehicle maintenance records
    - Consider extended warranty options

    These recommendations are based on current assessment findings and industry best practices. Final decisions should
    consider individual circumstances and insurance policy requirements.
    `.trim();

    document.getElementById('id_recommendations').value = recommendations;
    }

    function previewReport() {
    // Create a preview modal or new window
    const previewContent = `
    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
        <h1>Assessment Report Preview</h1>
        <h2>{{ assessment.assessment_id }}</h2>
        <hr>
        <h3>Executive Summary</h3>
        <p>${document.getElementById('id_executive_summary').value || 'No executive summary provided.'}</p>
        <h3>Detailed Findings</h3>
        <p>${document.getElementById('id_detailed_findings').value || 'No detailed findings provided.'}</p>
        <h3>Recommendations</h3>
        <p>${document.getElementById('id_recommendations').value || 'No recommendations provided.'}</p>
    </div>
    `;

    const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
    previewWindow.document.write(previewContent);
    previewWindow.document.close();
    }

    // Character counters for text areas
    function addCharacterCounters() {
    const textareas = ['id_executive_summary', 'id_detailed_findings', 'id_recommendations'];

    textareas.forEach(id => {
    const textarea = document.getElementById(id);
    if (textarea) {
    const counter = document.createElement('div');
    counter.className = 'text-sm text-gray-500 mt-1';
    counter.id = id + '_counter';
    textarea.parentNode.appendChild(counter);

    function updateCounter() {
    const length = textarea.value.length;
    counter.textContent = `${length} characters`;
    }

    textarea.addEventListener('input', updateCounter);
    updateCounter();
    }
    });
    }

    // Initialize character counters when page loads
    document.addEventListener('DOMContentLoaded', addCharacterCounters);
    </script>