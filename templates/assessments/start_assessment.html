{% extends 'base/base.html' %}
{% load static %}

{% block title %}Start Assessment - Carfinity{% endblock %}

{% block content %}
<br></br>
{% if user.is_authenticated %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start New Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#374151',
                        accent: '#f59e0b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-clipboard-check text-danger mr-2"></i>
                            Start New Assessment
                        </h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-user mr-1"></i>
                        {{ user.get_full_name|default:user.username }}
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Step Progress -->
        <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-danger">
            <div class="text-sm font-medium text-danger">01. Vehicle & Assessment Details</div>
            <div class="text-sm font-medium text-gray-400">02. Location & Context</div>
            <div class="text-sm font-medium text-gray-400">03. 120-Point Assessment</div>
            <div class="text-sm font-medium text-gray-400">04. Results & Report</div>
        </div>

        <!-- Header Card -->
        <div class="bg-white rounded-lg shadow p-6 border border-gray-200 mb-8">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                        120-Point Vehicle Assessment
                    </h2>
                    <p class="text-gray-600">Enter the basic vehicle and assessment details to begin the comprehensive damage evaluation process.</p>
                </div>
                <div class="flex items-center text-sm text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    <span>Step 1 of 14</span>
                </div>
            </div>
        </div>

        <!-- Form -->
        <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Vehicle & Assessment Details</h3>
                <p class="text-sm text-gray-500">Provide basic information to start the assessment</p>
            </div>
            <form method="post" class="p-6">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Assessment Type -->
                    <div>
                        <label for="{{ form.assessment_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Assessment Type <span class="text-red-500">*</span>
                        </label>
                        {{ form.assessment_type }}
                        {% if form.assessment_type.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.assessment_type.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Organization -->
                    <div>
                        <label for="{{ form.organization.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-building text-blue-600 mr-1"></i>
                            Organization <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            {{ form.organization }}
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                        {% if form.organization.errors %}
                        <p class="mt-1 text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            {{ form.organization.errors.0 }}
                        </p>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            Select the organization this assessment is being conducted for
                        </p>
                        {% if not form.organization.field.queryset %}
                        <p class="mt-1 text-sm text-amber-600">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            No organizations available. Please contact your administrator.
                        </p>
                        {% endif %}
                    </div>

                    <!-- Vehicle -->
                    <div>
                        <label for="{{ form.vehicle.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Vehicle <span class="text-red-500">*</span>
                        </label>
                        {{ form.vehicle }}
                        {% if form.vehicle.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.vehicle.errors.0 }}</p>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">Select the vehicle to be assessed</p>
                    </div>

                    <!-- Assessor Name -->
                    <div>
                        <label for="{{ form.assessor_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Assessor Name <span class="text-red-500">*</span>
                        </label>
                        {{ form.assessor_name }}
                        {% if form.assessor_name.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.assessor_name.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Assessor Certification -->
                    <div>
                        <label for="{{ form.assessor_certification.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Assessor Certification
                        </label>
                        {{ form.assessor_certification }}
                        {% if form.assessor_certification.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.assessor_certification.errors.0 }}</p>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">Certification number or credentials</p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-8 flex justify-between items-center space-x-4">
                    <a href="{% url 'assessments:dashboard' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-arrow-left mr-2"></i>Cancel
                    </a>
                    <button type="submit" class="bg-danger hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                        Continue to Location Details<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Help Text -->
        <div class="mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-red-600"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Assessment Types</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>Crash Assessment:</strong> Post-accident damage evaluation</li>
                            <li><strong>Pre-Purchase Assessment:</strong> Vehicle condition before purchase</li>
                            <li><strong>Periodic Assessment:</strong> Regular maintenance evaluation</li>
                            <li><strong>Insurance Claim:</strong> Insurance-related damage assessment</li>
                            <li><strong>Total Loss Assessment:</strong> Comprehensive loss evaluation</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Organization Selection Help -->
        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-building text-blue-600"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Organization Selection</h3>
                    <div class="mt-2 text-sm text-blue-700">
                        <p>The organization field determines:</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li>Assessment workflow and approval process</li>
                            <li>Report formatting and branding</li>
                            <li>Data access and permissions</li>
                            <li>Billing and cost allocation</li>
                        </ul>
                        <p class="mt-2 font-medium">Only organizations you are a member of will be shown in the dropdown.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for enhanced functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced organization dropdown functionality
            const organizationSelect = document.getElementById('{{ form.organization.id_for_label }}');
            const assessmentTypeSelect = document.getElementById('{{ form.assessment_type.id_for_label }}');
            
            if (organizationSelect) {
                // Add organization type icons to options
                Array.from(organizationSelect.options).forEach(option => {
                    if (option.value) {
                        const orgType = option.getAttribute('data-org-type') || 'other';
                        let icon = '';
                        
                        switch(orgType) {
                            case 'insurance':
                                icon = 'ðŸ›¡ï¸ ';
                                break;
                            case 'fleet':
                                icon = 'ðŸš› ';
                                break;
                            case 'dealership':
                                icon = 'ðŸª ';
                                break;
                            case 'service':
                                icon = 'ðŸ”§ ';
                                break;
                            default:
                                icon = 'ðŸ¢ ';
                        }
                        
                        if (!option.textContent.startsWith(icon)) {
                            option.textContent = icon + option.textContent;
                        }
                    }
                });
                
                // Add change event listener for organization selection
                organizationSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    
                    if (selectedOption.value) {
                        // Add visual feedback for selection
                        this.classList.remove('border-red-300', 'border-gray-300');
                        this.classList.add('border-green-400');
                        
                        // Show success message
                        showOrganizationFeedback('success', `Selected: ${selectedOption.textContent}`);
                        
                        // Show organization type info if available
                        const orgType = selectedOption.getAttribute('data-org-type');
                        if (orgType) {
                            console.log('Selected organization type:', orgType);
                        }
                    } else {
                        this.classList.remove('border-green-400');
                        this.classList.add('border-gray-300');
                        hideOrganizationFeedback();
                    }
                });
                
                // Check if organization is pre-selected
                if (organizationSelect.value) {
                    organizationSelect.classList.add('border-green-400');
                    const selectedOption = organizationSelect.options[organizationSelect.selectedIndex];
                    showOrganizationFeedback('success', `Pre-selected: ${selectedOption.textContent}`);
                }
                
                // Add placeholder option if none exists and there are options
                if (organizationSelect.options.length > 0 && organizationSelect.options[0].value !== '') {
                    const placeholderOption = document.createElement('option');
                    placeholderOption.value = '';
                    placeholderOption.textContent = '-- Select an Organization --';
                    placeholderOption.disabled = true;
                    placeholderOption.selected = !organizationSelect.value;
                    organizationSelect.insertBefore(placeholderOption, organizationSelect.firstChild);
                } else if (organizationSelect.options.length === 0) {
                    // No organizations available
                    const noOrgOption = document.createElement('option');
                    noOrgOption.value = '';
                    noOrgOption.textContent = 'No organizations available';
                    noOrgOption.disabled = true;
                    noOrgOption.selected = true;
                    organizationSelect.appendChild(noOrgOption);
                    
                    organizationSelect.classList.add('border-red-300', 'bg-red-50');
                    showOrganizationFeedback('error', 'No organizations available. Please contact your administrator.');
                }
            }
            
            // Helper function to show organization feedback
            function showOrganizationFeedback(type, message) {
                hideOrganizationFeedback();
                
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = `mt-2 p-2 rounded-md text-sm organization-feedback ${
                    type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' :
                    type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' :
                    'bg-blue-50 text-blue-700 border border-blue-200'
                }`;
                
                const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
                feedbackDiv.innerHTML = `${icon} ${message}`;
                
                const orgContainer = organizationSelect.closest('div');
                orgContainer.appendChild(feedbackDiv);
            }
            
            // Helper function to hide organization feedback
            function hideOrganizationFeedback() {
                const existingFeedback = document.querySelector('.organization-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
            }
            
            // Assessment type and organization compatibility check
            if (assessmentTypeSelect && organizationSelect) {
                assessmentTypeSelect.addEventListener('change', function() {
                    const assessmentType = this.value;
                    
                    // Highlight insurance organizations for insurance claims
                    if (assessmentType === 'insurance_claim') {
                        Array.from(organizationSelect.options).forEach(option => {
                            if (option.getAttribute('data-is-insurance') === 'true') {
                                option.style.backgroundColor = '#dbeafe'; // Light blue
                                option.style.fontWeight = 'bold';
                            } else if (option.value) {
                                option.style.backgroundColor = '#fef3c7'; // Light yellow
                                option.style.fontWeight = 'normal';
                            }
                        });
                    } else {
                        // Reset styling
                        Array.from(organizationSelect.options).forEach(option => {
                            option.style.backgroundColor = '';
                            option.style.fontWeight = '';
                        });
                    }
                });
            }
            
            // Form validation enhancement
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    let isValid = true;
                    
                    // Check organization selection
                    if (organizationSelect && !organizationSelect.value) {
                        e.preventDefault();
                        isValid = false;
                        
                        organizationSelect.classList.add('border-red-500');
                        organizationSelect.focus();
                        
                        // Show error message
                        let errorMsg = organizationSelect.parentNode.querySelector('.error-message');
                        if (!errorMsg) {
                            errorMsg = document.createElement('p');
                            errorMsg.className = 'mt-1 text-sm text-red-600 error-message';
                            errorMsg.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>Please select an organization';
                            organizationSelect.parentNode.appendChild(errorMsg);
                        }
                    }
                    
                    if (!isValid) {
                        // Scroll to first error
                        const firstError = document.querySelector('.border-red-500');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }
        });
    </script>
    </div>
</body>
</html>

{% else %}
  {% include "dashboard/login_dashboard.html" %}
{% endif %}
{% endblock %}
