{% extends 'base/base.html' %}
{% load static %}

{% block title %}Upload Assessment Photos - Carfinity{% endblock %}

{% block content %}
<br></br>
{% if user.is_authenticated %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Assessment Photos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#374151',
                        accent: '#f59e0b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        .photo-item {
            transition: all 0.3s ease;
        }
        
        .photo-item:hover {
            transform: translateY(-2px);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }
        
        .upload-zone {
            transition: all 0.3s ease;
            position: relative;
        }
        
        .upload-zone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .upload-zone input[type="file"] {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .progress-bar-animation {
            transition: width 0.3s ease;
        }
        
        .upload-zone.dragover {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
        }
        
        #imagePreview img {
            transition: all 0.3s ease;
        }
        
        #imagePreview:hover img {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-camera text-danger mr-2"></i>
                            Upload Assessment Photos
                        </h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-user mr-1"></i>
                        {{ user.get_full_name|default:user.username }}
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Step Progress -->
        <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-danger">
            <div class="text-sm font-medium text-success">01-14. Assessment Steps âœ“</div>
            <div class="text-sm font-medium text-danger">15. Photo Documentation</div>
            <div class="text-sm font-medium text-gray-400">16. Notes & Completion...</div>
        </div>

        <!-- Header Card -->
        <div class="bg-white rounded-lg shadow p-6 border border-gray-200 mb-8">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">
                        Upload Assessment Photos
                    </h2>
                    <p class="text-gray-600">Add documentation photos for {{ assessment.assessment_id }}</p>
                </div>
                <div class="flex items-center text-sm text-gray-500">
                    <i class="fas fa-images mr-1"></i>
                    <span>Photo Documentation</span>
                </div>
            </div>
        </div>

        <!-- Assessment Info -->
        <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-red-600 mr-2"></i>
                    <div>
                        <h3 class="text-sm font-medium text-red-800">Assessment: {{ assessment.assessment_id }}</h3>
                        <p class="text-sm text-red-700">Vehicle: {{ assessment.vehicle }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-red-700">Status: <span class="font-medium">{{ assessment.get_status_display }}</span></p>
                </div>
            </div>
        </div>

        <!-- Form -->
        <form id="photoUploadForm" method="post" enctype="multipart/form-data" class="space-y-8">
            {% csrf_token %}
            
            <!-- Upload Form -->
            <div class="bg-white rounded-lg shadow border border-gray-200 mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Upload New Photo</h3>
                    <p class="text-sm text-gray-500">Add documentation photos to support your assessment</p>
                </div>
                <div class="px-6 py-6">
                    <!-- Upload Progress Bar (Hidden by default) -->
                    <div id="uploadProgress" class="hidden mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-700">Uploading...</span>
                            <span id="progressPercent" class="text-sm text-blue-700">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Success Message (Hidden by default) -->
                    <div id="uploadSuccess" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <span class="text-sm text-green-800">Photo uploaded successfully!</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Category -->
                        <div>
                            <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Photo Category <span class="text-gray-400 text-xs">(Optional)</span>
                            </label>
                            <div class="space-y-2">
                                {{ form.category }}
                                {% if form.category.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.category.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Description <span class="text-gray-400 text-xs">(Optional)</span>
                            </label>
                            <div class="space-y-2">
                                {{ form.description }}
                                {% if form.description.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Image Upload with Preview and Drag & Drop -->
                        <div class="md:col-span-2">
                            <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Select Image <span class="text-gray-400 text-xs">(Optional)</span>
                            </label>
                            <div class="space-y-2">
                                <!-- Drag & Drop Zone -->
                                <div id="dropZone" class="upload-zone border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all duration-300">
                                    <div id="dropZoneContent">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-sm text-gray-600 mb-2">
                                            <span class="font-medium text-blue-600">Click to upload</span> or drag and drop
                                        </p>
                                        <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                    </div>
                                    {{ form.image }}
                                </div>
                                
                                {% if form.image.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.image.errors.0 }}</p>
                                {% endif %}
                                
                                <!-- Image Preview -->
                                <div id="imagePreview" class="hidden mt-4">
                                    <div class="relative inline-block">
                                        <img id="previewImg" src="" alt="Preview" class="max-w-xs h-32 object-cover rounded-lg border border-gray-200">
                                        <button type="button" id="removePreview" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-between items-center space-x-4">
                <a href="{% url 'assessments:financial_information' assessment.id %}" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Financial Info
                </a>
                <div class="flex space-x-3">
                    <button type="submit" id="uploadBtn" class="bg-success hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="uploadBtnText">Upload Photo</span>
                        <i id="uploadBtnIcon" class="fas fa-upload ml-2"></i>
                    </button>
                    <a href="{% url 'assessments:assessment_notes' assessment.id %}" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-forward mr-2"></i>Skip Photos
                    </a>
                    <button type="submit" name="continue_to_notes" class="bg-danger hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg text-sm transition duration-200">
                        Continue to Notes<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </form>

        <!-- Existing Photos -->
        <div id="photosContainer" class="bg-white rounded-lg shadow border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Existing Photos (<span id="photoCount">{{ photos.count }}</span>)</h3>
                <p class="text-sm text-gray-500">Photos uploaded for this assessment</p>
            </div>
            <div class="px-6 py-6">
                <div id="photosGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% if photos %}
                        {% for photo in photos %}
                        <div class="photo-item border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow" data-photo-id="{{ photo.id }}">
                            <img src="{{ photo.image.url }}" alt="{{ photo.description }}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-medium text-gray-900">{{ photo.get_category_display }}</h4>
                                    <span class="text-xs text-gray-500">{{ photo.taken_at|date:"M d, Y" }}</span>
                                </div>
                                {% if photo.description %}
                                <p class="text-sm text-gray-600 mb-2">{{ photo.description }}</p>
                                {% endif %}
                                <div class="flex space-x-2">
                                    <a href="{{ photo.image.url }}" target="_blank" class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                                        <i class="fas fa-external-link-alt mr-1"></i>View Full Size
                                    </a>
                                    <button onclick="deletePhoto({{ photo.id }})" class="text-red-600 hover:text-red-900 text-sm font-medium">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div id="noPhotosMessage" class="col-span-full text-center py-12">
                            <i class="fas fa-camera mx-auto h-12 w-12 text-gray-400 text-5xl mb-4"></i>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No photos uploaded yet</h3>
                            <p class="mt-1 text-sm text-gray-500">Upload your first photo to get started.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Photo Categories Guide -->
        <div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-info-circle text-red-600 mr-2"></i>Photo Categories Guide
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-car text-blue-600"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900">Overall Vehicle</h4>
                    <p class="text-xs text-gray-600">Full vehicle shots from multiple angles</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900">Damage Detail</h4>
                    <p class="text-xs text-gray-600">Close-up shots of specific damage areas</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-couch text-green-600"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900">Interior</h4>
                    <p class="text-xs text-gray-600">Interior damage, seats, dashboard, etc.</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-cog text-yellow-600"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900">Engine Bay</h4>
                    <p class="text-xs text-gray-600">Engine compartment and mechanical components</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-tools text-purple-600"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900">Undercarriage</h4>
                    <p class="text-xs text-gray-600">Underneath the vehicle, frame, suspension</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-file-alt text-gray-600"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900">Documentation</h4>
                    <p class="text-xs text-gray-600">VIN plates, stickers, maintenance records</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

{% else %}
  {% include "dashboard/login_dashboard.html" %}
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('photoUploadForm');
    const fileInput = document.querySelector('input[type="file"]');
    const dropZone = document.getElementById('dropZone');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const removePreview = document.getElementById('removePreview');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const uploadSuccess = document.getElementById('uploadSuccess');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const uploadBtnIcon = document.getElementById('uploadBtnIcon');

    // Drag and drop functionality
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-blue-400', 'bg-blue-50');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });

    // Image preview functionality
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleFileSelect(file);
        } else {
            imagePreview.classList.add('hidden');
        }
    });

    // Remove preview functionality
    removePreview.addEventListener('click', function() {
        fileInput.value = '';
        imagePreview.classList.add('hidden');
    });

    function handleFileSelect(file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }
        
        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            imagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // Enhanced form submission with progress
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Check if an image is selected
        const hasImage = fileInput.files && fileInput.files.length > 0;
        console.log('Form submitted. Has image:', hasImage);
        
        // Allow form submission even without image (since fields are now optional)
        if (!hasImage) {
            console.log('No image selected, but allowing form submission');
        }
        
        const formData = new FormData(form);
        console.log('FormData created with entries:', [...formData.entries()]);
        
        // Show progress and disable button
        uploadProgress.classList.remove('hidden');
        uploadSuccess.classList.add('hidden');
        uploadBtn.disabled = true;
        uploadBtnText.textContent = 'Uploading...';
        uploadBtnIcon.className = 'fas fa-spinner fa-spin ml-2';

        // Create XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        // Progress tracking
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressPercent.textContent = Math.round(percentComplete) + '%';
                console.log('Upload progress:', percentComplete + '%');
            }
        });

        // Handle response
        xhr.addEventListener('load', function() {
            console.log('Upload completed. Status:', xhr.status);
            console.log('Response:', xhr.responseText);
            
            if (xhr.status === 200) {
                try {
                    // Try to parse as JSON first (AJAX response)
                    const response = JSON.parse(xhr.responseText);
                    console.log('Parsed JSON response:', response);
                    if (response.success) {
                        handleUploadSuccess();
                    } else {
                        handleUploadError(response.message);
                    }
                } catch (e) {
                    console.log('Not JSON response, treating as success');
                    // If not JSON, it's likely a full HTML response (fallback)
                    handleUploadSuccess();
                }
            } else {
                handleUploadError();
            }
        });

        xhr.addEventListener('error', function() {
            console.error('Upload error occurred');
            handleUploadError();
        });

        // Send request
        xhr.open('POST', form.action);
        console.log('Sending request to:', form.action);
        xhr.send(formData);
    });

    function handleUploadSuccess() {
        // Hide progress, show success
        uploadProgress.classList.add('hidden');
        uploadSuccess.classList.remove('hidden');
        
        // Reset form
        form.reset();
        imagePreview.classList.add('hidden');
        
        // Re-enable button
        uploadBtn.disabled = false;
        uploadBtnText.textContent = 'Upload Photo';
        uploadBtnIcon.className = 'fas fa-upload ml-2';
        
        // Refresh photos section
        refreshPhotosSection();
        
        // Hide success message after 3 seconds
        setTimeout(() => {
            uploadSuccess.classList.add('hidden');
        }, 3000);
    }

    function handleUploadError(message = 'Error uploading photo. Please try again.') {
        uploadProgress.classList.add('hidden');
        uploadBtn.disabled = false;
        uploadBtnText.textContent = 'Upload Photo';
        uploadBtnIcon.className = 'fas fa-upload ml-2';
        alert(message);
    }

    function refreshPhotosSection() {
        // Fetch updated photos via AJAX
        fetch(window.location.href, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Parse the response and update photos section
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newPhotosGrid = doc.getElementById('photosGrid');
            const newPhotoCount = doc.getElementById('photoCount');
            
            if (newPhotosGrid && newPhotoCount) {
                document.getElementById('photosGrid').innerHTML = newPhotosGrid.innerHTML;
                document.getElementById('photoCount').textContent = newPhotoCount.textContent;
                
                // Add fade-in animation to new photos
                const photoItems = document.querySelectorAll('.photo-item');
                photoItems.forEach((item, index) => {
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        item.style.transition = 'all 0.3s ease';
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            }
        })
        .catch(error => {
            console.error('Error refreshing photos:', error);
        });
    }
});

function deletePhoto(photoId) {
    if (confirm('Are you sure you want to delete this photo?')) {
        const photoItem = document.querySelector(`[data-photo-id="${photoId}"]`);
        
        // Add fade-out animation
        if (photoItem) {
            photoItem.style.transition = 'all 0.3s ease';
            photoItem.style.opacity = '0';
            photoItem.style.transform = 'scale(0.9)';
        }
        
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "assessments:delete_photo" assessment.id %}';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        
        const photoIdInput = document.createElement('input');
        photoIdInput.type = 'hidden';
        photoIdInput.name = 'photo_id';
        photoIdInput.value = photoId;
        
        form.appendChild(csrfInput);
        form.appendChild(photoIdInput);
        document.body.appendChild(form);
        
        // Submit after animation
        setTimeout(() => {
            form.submit();
        }, 300);
    }
}
</script>
{% endblock %}
