{% extends "admin/base_site.html" %}
{% load admin_urls static %}

{% block title %}Organization-Group Management{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .org-card, .group-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .status-info { color: #17a2b8; }
        .group-tag {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .group-customers { background: #d4edda; color: #155724; }
        .group-insurance { background: #cce5ff; color: #004085; }
        .group-other { background: #e2e3e5; color: #383d41; }
        .sync-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .sync-button:hover { background: #005a87; }
        .section-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-left: 4px solid #007cba;
            margin: 20px 0 15px 0;
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
<div class="module">
    <h1>Organization-Group Management</h1>
    <p>Manage the relationships between organizations and Django groups for automatic user permission assignment.</p>
    
    <!-- Organizations Section -->
    <div class="section-header">Organizations and Their Linked Groups</div>
    
    {% for item in org_data %}
    <div class="org-card">
        <div style="display: flex; justify-content: between; align-items: center;">
            <div style="flex-grow: 1;">
                <h3>
                    <a href="{% url 'admin:organizations_organization_change' item.organization.id %}">
                        {{ item.organization.name }}
                    </a>
                    <small>({{ item.organization.get_organization_type_display }})</small>
                </h3>
            </div>
            <div>
                {% if item.sync_issues > 0 %}
                    <button class="sync-button" onclick="syncOrganization({{ item.organization.id }})">
                        Sync {{ item.sync_issues }} Users
                    </button>
                {% endif %}
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px;">
            <!-- Linked Groups -->
            <div>
                <strong>Linked Groups:</strong><br>
                {% if item.linked_groups %}
                    {% for group in item.linked_groups %}
                        <span class="group-tag group-{% if group.name == 'customers' %}customers{% elif group.name == 'insurance_company' %}insurance{% else %}other{% endif %}">
                            {{ group.name }}
                        </span>
                    {% endfor %}
                {% else %}
                    <span class="status-error">No groups linked!</span>
                {% endif %}
            </div>
            
            <!-- Recommended Groups -->
            <div>
                <strong>Recommended:</strong><br>
                {% if item.recommended_groups %}
                    {% for group_name in item.recommended_groups %}
                        {% if group_name not in item.linked_groups|join:"," %}
                            <span class="group-tag group-{% if group_name == 'customers' %}customers{% elif group_name == 'insurance_company' %}insurance{% else %}other{% endif %}" style="opacity: 0.6;">
                                {{ group_name }} (missing)
                            </span>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            
            <!-- Member Status -->
            <div>
                <strong>Members:</strong><br>
                <span class="status-info">{{ item.active_members|length }} active</span>
                {% if item.sync_issues > 0 %}
                    <br><span class="status-error">{{ item.sync_issues }} need sync</span>
                {% else %}
                    <br><span class="status-good">All synced</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p>No organizations found.</p>
    {% endfor %}
    
    <!-- Groups Section -->
    <div class="section-header">Groups and Their Linked Organizations</div>
    
    {% for item in group_data %}
    <div class="group-card">
        <h3>
            <a href="{% url 'admin:auth_group_change' item.group.id %}">
                {{ item.group.name }}
            </a>
            <small>({{ item.user_count }} users, {{ item.org_count }} organizations)</small>
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
            <!-- Dashboard Access -->
            <div>
                <strong>Dashboard Access:</strong><br>
                <span class="status-info">{{ item.dashboard_access }}</span>
            </div>
            
            <!-- Linked Organizations -->
            <div>
                <strong>Linked Organizations:</strong><br>
                {% if item.linked_organizations %}
                    {% for org in item.linked_organizations %}
                        <a href="{% url 'admin:organizations_organization_change' org.id %}">{{ org.name }}</a>
                        <small>({{ org.get_organization_type_display }})</small>
                        {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% else %}
                    <span class="status-warning">No organizations linked</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p>No groups found.</p>
    {% endfor %}
    
    <!-- Quick Actions -->
    <div class="section-header">Quick Actions</div>
    <div style="background: #e9ecef; padding: 15px; border-radius: 5px;">
        <p>
            <a href="{% url 'admin:organizations_organization_add' %}" class="button">Add Organization</a>
            <a href="{% url 'admin:auth_group_add' %}" class="button">Add Group</a>
            <a href="{% url 'admin:organizations_organizationuser_changelist' %}" class="button">Manage Organization Users</a>
        </p>
        <p>
            <strong>Tips:</strong>
            <ul>
                <li>Insurance companies should be linked to the "insurance_company" group</li>
                <li>Fleet, dealership, and service organizations should be linked to the "customers" group</li>
                <li>Users automatically get added to linked groups when they join an organization</li>
                <li>Use the sync buttons to fix any group assignment issues</li>
            </ul>
        </p>
    </div>
</div>

<script>
function syncOrganization(orgId) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Syncing...';
    button.disabled = true;
    
    fetch('/admin/organizations/ajax/sync-groups/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: `org_id=${orgId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.textContent = 'Synced!';
            button.style.background = '#28a745';
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            button.textContent = 'Error';
            button.style.background = '#dc3545';
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        button.textContent = 'Error';
        button.style.background = '#dc3545';
        alert('Network error: ' + error);
    })
    .finally(() => {
        button.disabled = false;
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '#007cba';
        }, 2000);
    });
}
</script>

{% csrf_token %}
{% endblock %}